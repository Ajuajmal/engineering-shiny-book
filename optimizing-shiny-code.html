<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 17 Optimizing Shiny Code | Engineering Production-Grade Shiny Apps</title>
  <meta name="description" content="Chapter 17 Optimizing Shiny Code | Engineering Production-Grade Shiny Apps" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 17 Optimizing Shiny Code | Engineering Production-Grade Shiny Apps" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Chapter 17 Optimizing Shiny Code | Engineering Production-Grade Shiny Apps" />
  <meta name="github-repo" content="ThinkR-open/building-shiny-apps-workflow" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 17 Optimizing Shiny Code | Engineering Production-Grade Shiny Apps" />
  
  <meta name="twitter:description" content="Chapter 17 Optimizing Shiny Code | Engineering Production-Grade Shiny Apps" />
  

<meta name="author" content="Colin Fay, Sébastien Rochette, Vincent Guyader, Cervan Girard" />


<meta name="date" content="2020-04-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="prev" href="optim-caveat.html"/>
<link rel="next" href="optimjs.html"/>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149994171-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-149994171-1');
</script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/thinkr.css" type="text/css" />
<link rel="stylesheet" href="css/style_gitbook.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Engineering Production-Grade Shiny Apps</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>I Building Successful Shiny Apps</b></span></li>
<li class="chapter" data-level="1" data-path="successfulshinyapp.html"><a href="successfulshinyapp.html"><i class="fa fa-check"></i><b>1</b> About Successful Shiny Apps</a></li>
<li class="chapter" data-level="2" data-path="planning.html"><a href="planning.html"><i class="fa fa-check"></i><b>2</b> Planning Ahead</a></li>
<li class="chapter" data-level="3" data-path="structure.html"><a href="structure.html"><i class="fa fa-check"></i><b>3</b> Structuring your Project</a></li>
<li class="chapter" data-level="4" data-path="golem.html"><a href="golem.html"><i class="fa fa-check"></i><b>4</b> Introduction to <code>{golem}</code></a></li>
<li class="chapter" data-level="5" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>5</b> The workflow</a></li>
<li class="part"><span><b>II Step 1: Design</b></span></li>
<li class="chapter" data-level="6" data-path="matters.html"><a href="matters.html"><i class="fa fa-check"></i><b>6</b> UX Matters</a></li>
<li class="chapter" data-level="7" data-path="step-design.html"><a href="step-design.html"><i class="fa fa-check"></i><b>7</b> Don’t rush into coding</a></li>
<li class="chapter" data-level="8" data-path="css.html"><a href="css.html"><i class="fa fa-check"></i><b>8</b> A Gentle Introduction to CSS</a></li>
<li class="part"><span><b>III Step 2: Prototype</b></span></li>
<li class="chapter" data-level="9" data-path="setting-up-for-success-with-golem.html"><a href="setting-up-for-success-with-golem.html"><i class="fa fa-check"></i><b>9</b> Setting up for success with <code>{golem}</code></a></li>
<li class="chapter" data-level="10" data-path="stepprotopype.html"><a href="stepprotopype.html"><i class="fa fa-check"></i><b>10</b> Building an “ipsum-app”</a></li>
<li class="part"><span><b>IV Step 3: Build</b></span></li>
<li class="chapter" data-level="11" data-path="stepbuild.html"><a href="stepbuild.html"><i class="fa fa-check"></i><b>11</b> Building app with <code>{golem}</code></a></li>
<li class="part"><span><b>V Step 4: Strengthen</b></span></li>
<li class="chapter" data-level="12" data-path="step-secure.html"><a href="step-secure.html"><i class="fa fa-check"></i><b>12</b> Build yourself a safety net</a></li>
<li class="chapter" data-level="13" data-path="secure.html"><a href="secure.html"><i class="fa fa-check"></i><b>13</b> Version Control</a></li>
<li class="chapter" data-level="14" data-path="deploy-golem.html"><a href="deploy-golem.html"><i class="fa fa-check"></i><b>14</b> Deploy your application</a></li>
<li class="part"><span><b>VI Optimizing</b></span></li>
<li class="chapter" data-level="15" data-path="when-optimize.html"><a href="when-optimize.html"><i class="fa fa-check"></i><b>15</b> The Need for Optimization</a></li>
<li class="chapter" data-level="16" data-path="optim-caveat.html"><a href="optim-caveat.html"><i class="fa fa-check"></i><b>16</b> Common Application Caveats</a></li>
<li class="chapter" data-level="17" data-path="optimizing-shiny-code.html"><a href="optimizing-shiny-code.html"><i class="fa fa-check"></i><b>17</b> Optimizing Shiny Code</a></li>
<li class="chapter" data-level="18" data-path="optimjs.html"><a href="optimjs.html"><i class="fa fa-check"></i><b>18</b> Using JavaScript</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://rtask.thinkr.fr">A book by the ThinkR team</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Engineering Production-Grade Shiny Apps</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="optimizing-shiny-code" class="section level1">
<h1><span class="header-section-number">Chapter 17</span> Optimizing Shiny Code</h1>
<div id="optimizing-r-code" class="section level2">
<h2><span class="header-section-number">17.1</span> Optimizing R code</h2>
<p>In its core, Shiny runs R code on the server side.
So to be efficient, the R code computing your values and returning results also has to be optimized.</p>
<p>Optimizing R code is such a broad topic that it would be possible to write a full book about it, and in fact a lot of books about R already cover this topic.
Instead of re-writing these books, we will try to point to some crucial resources you can refer to if you want get started optimizing your R code.</p>
<ul>
<li><p>Efficient R programming <span class="citation">(Gillespie and Lovelace <a href="#ref-colingillespie2017" role="doc-biblioref">2017</a>)</span>, has a series of methods you can quickly put into practice for more efficient R code.</p></li>
<li><p>Advanced R <span class="citation">(Wickham <a href="#ref-hadleywickham2019" role="doc-biblioref">2019</a>)</span> has a chapter about optimizing R code (number 24).
In the rest of this chapter, we will be focusing on how to optimize Shiny specifically.</p></li>
</ul>
</div>
<div id="caching-elements" class="section level2">
<h2><span class="header-section-number">17.2</span> Caching elements</h2>
<div id="what-is-caching" class="section level3">
<h3><span class="header-section-number">17.2.1</span> What is caching?</h3>
<p>Caching is the process of storing resources intensive results so that when they are needed again, your program can reuse the result another time without having to redo the computation again.</p>
<p>How does it work?
Let’s make a brief parallel with the human brain, and imagine that you know that you will need to use a phone number many time in the day, and for the purpose of this thought experiment you are completely unable to remember it.<a href="#fn41" class="footnote-ref" id="fnref41"><sup>41</sup></a>
What are you going to do?
There are two solutions here: either you look in the phone book or in your phone contact list every time you need it, which takes a couple of seconds every time, or you use a post-it that you put on your computer screen with the number of it, so that you have direct access to it when you need it.
It takes a couple of seconds the first time you look for the number, but it is almost instantaneous the next times you need it.</p>
<p>This is what caching do: keep the result of computation so when they are needed in the very same context, they are quickly accessible.
The downside being that you only have limited space on your screen: when your screen is covered by sticky notes, you can not store any more notes.<a href="#fn42" class="footnote-ref" id="fnref42"><sup>42</sup></a></p>
<p>In the context of an interactive application in a framework like Shiny, it makes much sense to cache data structures: users tend to repeat what they do, or go back and forth between parameters.
For example, if you have a graph that take 2 seconds to render (which is quite common in Shiny, notably when relying on <code>{ggplot2}</code> <span class="citation">(Wickham, Chang, et al. <a href="#ref-R-ggplot2" role="doc-biblioref">2020</a>)</span>), you do not want these 2 seconds to be repeated over and over again when users switch from one parameter to another and back to the first, as the two graphs will be the same for the same parameter.
Same goes for queries to a database: if a query is done with the same parameters, and you know that they will return the same result, there is no need to ask the database again and again—ask the cache to retrieve the data.</p>
</div>
<div id="native-caching-in-r" class="section level3">
<h3><span class="header-section-number">17.2.2</span> Native Caching in R</h3>
<p>At least two packages in R implement caching of functions (also called memoization): <code>{R.cache}</code> <span class="citation">(Bengtsson <a href="#ref-R-R.cache" role="doc-biblioref">2019</a>)</span>, and <code>{memoise}</code> <span class="citation">(Wickham, Hester, et al. <a href="#ref-R-memoise" role="doc-biblioref">2017</a>)</span>.
They both more or less work the same way: you will call a memoization function on another function, and cache is created for this function output, based on the arguments value.
Then every time you call this function again with the same parameters, the cache is returned instead of computing the function another time.
So for example, if computing your data once takes 5 seconds with the parameter <code>n = 50</code>, the next time you will be calling this function with <code>n = 50</code>, instead of recomputing, R will go and fetch the value stored in cache.</p>
<p>Here is a simple example with <code>{memoise}</code>:</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="optimizing-shiny-code.html#cb231-1"></a><span class="kw">library</span>(memoise)</span>
<span id="cb231-2"><a href="optimizing-shiny-code.html#cb231-2"></a><span class="kw">library</span>(tictoc)</span>
<span id="cb231-3"><a href="optimizing-shiny-code.html#cb231-3"></a>fct &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">sleep =</span> <span class="dv">1</span>){</span>
<span id="cb231-4"><a href="optimizing-shiny-code.html#cb231-4"></a>  <span class="kw">Sys.sleep</span>(sleep)</span>
<span id="cb231-5"><a href="optimizing-shiny-code.html#cb231-5"></a>  <span class="kw">return</span>(<span class="kw">Sys.time</span>())</span>
<span id="cb231-6"><a href="optimizing-shiny-code.html#cb231-6"></a>}</span>
<span id="cb231-7"><a href="optimizing-shiny-code.html#cb231-7"></a>mfct &lt;-<span class="st"> </span><span class="kw">memoise</span>(fct)</span>
<span id="cb231-8"><a href="optimizing-shiny-code.html#cb231-8"></a><span class="kw">tic</span>()</span>
<span id="cb231-9"><a href="optimizing-shiny-code.html#cb231-9"></a><span class="kw">mfct</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] &quot;2020-04-27 20:29:58 UTC&quot;</code></pre>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="optimizing-shiny-code.html#cb233-1"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>2.013 sec elapsed</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="optimizing-shiny-code.html#cb235-1"></a><span class="kw">tic</span>()</span>
<span id="cb235-2"><a href="optimizing-shiny-code.html#cb235-2"></a><span class="kw">mfct</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] &quot;2020-04-27 20:29:58 UTC&quot;</code></pre>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="optimizing-shiny-code.html#cb237-1"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>0.024 sec elapsed</code></pre>
<p>Let’s try with another example that might look more like what we can find in a Shiny App: connecting to a database, using the <code>{DBI}</code> <span class="citation">(R Special Interest Group on Databases (R-SIG-DB), Wickham, and Müller <a href="#ref-R-DBI" role="doc-biblioref">2019</a>)</span> and <code>{RSQLite}</code> <span class="citation">(Müller et al. <a href="#ref-R-RSQLite" role="doc-biblioref">2020</a>)</span> packages</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="optimizing-shiny-code.html#cb239-1"></a>con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</span>
<span id="cb239-2"><a href="optimizing-shiny-code.html#cb239-2"></a>  RSQLite<span class="op">::</span><span class="kw">SQLite</span>(), </span>
<span id="cb239-3"><a href="optimizing-shiny-code.html#cb239-3"></a>  <span class="dt">dbname =</span> <span class="st">&quot;:memory:&quot;</span></span>
<span id="cb239-4"><a href="optimizing-shiny-code.html#cb239-4"></a>)</span>
<span id="cb239-5"><a href="optimizing-shiny-code.html#cb239-5"></a></span>
<span id="cb239-6"><a href="optimizing-shiny-code.html#cb239-6"></a><span class="co"># Writing a large dataset to the db</span></span>
<span id="cb239-7"><a href="optimizing-shiny-code.html#cb239-7"></a>DBI<span class="op">::</span><span class="kw">dbWriteTable</span>(</span>
<span id="cb239-8"><a href="optimizing-shiny-code.html#cb239-8"></a>  con, </span>
<span id="cb239-9"><a href="optimizing-shiny-code.html#cb239-9"></a>  <span class="st">&quot;diams&quot;</span>, </span>
<span id="cb239-10"><a href="optimizing-shiny-code.html#cb239-10"></a>  dplyr<span class="op">::</span><span class="kw">bind_rows</span>(</span>
<span id="cb239-11"><a href="optimizing-shiny-code.html#cb239-11"></a>    purrr<span class="op">::</span><span class="kw">rerun</span>(<span class="dv">10</span>, ggplot2<span class="op">::</span>diamonds)</span>
<span id="cb239-12"><a href="optimizing-shiny-code.html#cb239-12"></a>  )</span>
<span id="cb239-13"><a href="optimizing-shiny-code.html#cb239-13"></a>)</span>
<span id="cb239-14"><a href="optimizing-shiny-code.html#cb239-14"></a></span>
<span id="cb239-15"><a href="optimizing-shiny-code.html#cb239-15"></a><span class="co"># Do a query to the SQL db</span></span>
<span id="cb239-16"><a href="optimizing-shiny-code.html#cb239-16"></a>fct_sql &lt;-<span class="st"> </span><span class="cf">function</span>(SQL, con){</span>
<span id="cb239-17"><a href="optimizing-shiny-code.html#cb239-17"></a>  DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</span>
<span id="cb239-18"><a href="optimizing-shiny-code.html#cb239-18"></a>    con, SQL</span>
<span id="cb239-19"><a href="optimizing-shiny-code.html#cb239-19"></a>  ) </span>
<span id="cb239-20"><a href="optimizing-shiny-code.html#cb239-20"></a>}</span>
<span id="cb239-21"><a href="optimizing-shiny-code.html#cb239-21"></a>mfct &lt;-<span class="st"> </span><span class="kw">memoise</span>(fct_sql)</span>
<span id="cb239-22"><a href="optimizing-shiny-code.html#cb239-22"></a><span class="kw">tic</span>()</span>
<span id="cb239-23"><a href="optimizing-shiny-code.html#cb239-23"></a>res_a &lt;-<span class="st"> </span><span class="kw">mfct</span>(<span class="st">&quot;SELECT * FROM diams WHERE cut = &#39;Ideal&#39;&quot;</span>, con)</span>
<span id="cb239-24"><a href="optimizing-shiny-code.html#cb239-24"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>0.617 sec elapsed</code></pre>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="optimizing-shiny-code.html#cb241-1"></a><span class="kw">tic</span>()</span>
<span id="cb241-2"><a href="optimizing-shiny-code.html#cb241-2"></a>res_b &lt;-<span class="st"> </span><span class="kw">mfct</span>(<span class="st">&quot;SELECT * FROM diams WHERE cut = &#39;Ideal&#39;&quot;</span>, con)</span>
<span id="cb241-3"><a href="optimizing-shiny-code.html#cb241-3"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>0.024 sec elapsed</code></pre>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="optimizing-shiny-code.html#cb243-1"></a><span class="kw">all.equal</span>(res_a, res_b)</span></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="optimizing-shiny-code.html#cb245-1"></a><span class="kw">tic</span>()</span>
<span id="cb245-2"><a href="optimizing-shiny-code.html#cb245-2"></a>res_c &lt;-<span class="st"> </span><span class="kw">mfct</span>(<span class="st">&quot;SELECT * FROM diams WHERE cut = &#39;Good&#39;&quot;</span>, con)</span>
<span id="cb245-3"><a href="optimizing-shiny-code.html#cb245-3"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>0.173 sec elapsed</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="optimizing-shiny-code.html#cb247-1"></a><span class="kw">setequal</span>(res_a, res_c)</span></code></pre></div>
<pre><code>[1] FALSE</code></pre>
<p>Note that you can change where the cache is stored by <code>{memoise}</code>.
Here, we will save it in a temp directory (but do not do this in production).</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="optimizing-shiny-code.html#cb249-1"></a>tpd &lt;-<span class="st"> </span>fs<span class="op">::</span><span class="kw">path</span>(<span class="kw">paste</span>(<span class="kw">sample</span>(letters, <span class="dv">10</span>), <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="optimizing-shiny-code.html#cb250-1"></a>tpd &lt;-<span class="st"> </span>fs<span class="op">::</span><span class="kw">dir_create</span>(tpd)</span>
<span id="cb250-2"><a href="optimizing-shiny-code.html#cb250-2"></a>dfs &lt;-<span class="st"> </span><span class="kw">cache_filesystem</span>(tpd)</span>
<span id="cb250-3"><a href="optimizing-shiny-code.html#cb250-3"></a>mfct &lt;-<span class="st"> </span><span class="kw">memoise</span>(fct_sql, <span class="dt">cache =</span> dfs)</span>
<span id="cb250-4"><a href="optimizing-shiny-code.html#cb250-4"></a>res_a &lt;-<span class="st"> </span><span class="kw">mfct</span>(<span class="st">&quot;SELECT * FROM diams WHERE cut = &#39;Ideal&#39;&quot;</span>, con)</span>
<span id="cb250-5"><a href="optimizing-shiny-code.html#cb250-5"></a>res_b &lt;-<span class="st"> </span><span class="kw">mfct</span>(<span class="st">&quot;SELECT * FROM diams WHERE cut = &#39;Good&#39;&quot;</span>, con)</span>
<span id="cb250-6"><a href="optimizing-shiny-code.html#cb250-6"></a>fs<span class="op">::</span><span class="kw">dir_tree</span>(tpd)</span></code></pre></div>
<pre><code>[01;34memgyxvdckt[0m
├── 67b1637060b6a462
└── a314e0df2cb8ee21</code></pre>
<p>As you can see, we now have two cache objects inside the directory we have specified as a <code>cache_filesystem</code>.</p>
</div>
<div id="caching-shiny" class="section level3">
<h3><span class="header-section-number">17.2.3</span> Caching Shiny</h3>
<p>At the time of writing this page (April 2020), <code>{shiny}</code> <span class="citation">(Chang et al. <a href="#ref-R-shiny" role="doc-biblioref">2020</a>)</span> has one caching function: <code>renderCachedPlot()</code>.
This function behaves more or less like the <code>renderPlot()</code> function, except that it is tailored for caching.
The extra arguments you will find are <code>cacheKeyExpr</code> and <code>sizePolicy</code>: the former is the list of inputs and values that allow to cache the plot—every time these values and inputs are the same, they produce the same graph, so <code>{shiny}</code> will be fetching inside the cache instead of computing the value another time.
<code>sizePolicy</code> is a function that returns a <code>width</code> and an <code>height</code>, and which are used to round the plot dimension in pixels, so that not every pixel combination are generated in the cache.</p>
<p>The good news is that converting existing <code>renderPlot()</code> functions to <code>renderCachedPlot()</code> is pretty straightforward in most cases: take your current <code>renderPlot()</code>, and add the cache keys.<a href="#fn43" class="footnote-ref" id="fnref43"><sup>43</sup></a></p>
<p>Here is an example:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="optimizing-shiny-code.html#cb252-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb252-2"><a href="optimizing-shiny-code.html#cb252-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb252-3"><a href="optimizing-shiny-code.html#cb252-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb252-4"><a href="optimizing-shiny-code.html#cb252-4"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;tbl&quot;</span>, <span class="st">&quot;Table&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;iris&quot;</span>, <span class="st">&quot;mtcars&quot;</span>, <span class="st">&quot;airquality&quot;</span>)),</span>
<span id="cb252-5"><a href="optimizing-shiny-code.html#cb252-5"></a>    <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb252-6"><a href="optimizing-shiny-code.html#cb252-6"></a>  )</span>
<span id="cb252-7"><a href="optimizing-shiny-code.html#cb252-7"></a>}</span>
<span id="cb252-8"><a href="optimizing-shiny-code.html#cb252-8"></a></span>
<span id="cb252-9"><a href="optimizing-shiny-code.html#cb252-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb252-10"><a href="optimizing-shiny-code.html#cb252-10"></a>  input, </span>
<span id="cb252-11"><a href="optimizing-shiny-code.html#cb252-11"></a>  output, </span>
<span id="cb252-12"><a href="optimizing-shiny-code.html#cb252-12"></a>  session</span>
<span id="cb252-13"><a href="optimizing-shiny-code.html#cb252-13"></a>){</span>
<span id="cb252-14"><a href="optimizing-shiny-code.html#cb252-14"></a>  </span>
<span id="cb252-15"><a href="optimizing-shiny-code.html#cb252-15"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderCachedPlot</span>({</span>
<span id="cb252-16"><a href="optimizing-shiny-code.html#cb252-16"></a>    <span class="kw">plot</span>(</span>
<span id="cb252-17"><a href="optimizing-shiny-code.html#cb252-17"></a>      <span class="kw">get</span>(input<span class="op">$</span>tbl)</span>
<span id="cb252-18"><a href="optimizing-shiny-code.html#cb252-18"></a>    )</span>
<span id="cb252-19"><a href="optimizing-shiny-code.html#cb252-19"></a>  }, <span class="dt">cacheKeyExpr =</span> {</span>
<span id="cb252-20"><a href="optimizing-shiny-code.html#cb252-20"></a>    input<span class="op">$</span>tbl</span>
<span id="cb252-21"><a href="optimizing-shiny-code.html#cb252-21"></a>  })</span>
<span id="cb252-22"><a href="optimizing-shiny-code.html#cb252-22"></a>  </span>
<span id="cb252-23"><a href="optimizing-shiny-code.html#cb252-23"></a>}</span>
<span id="cb252-24"><a href="optimizing-shiny-code.html#cb252-24"></a></span>
<span id="cb252-25"><a href="optimizing-shiny-code.html#cb252-25"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>If you try this app, the first rendering of the three plots will take a little bit of time, but every subsequent rendering of the plot is almost instantaneous.</p>
<p>And if we apply what we have just seen with <code>{memoise}</code>:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="optimizing-shiny-code.html#cb253-1"></a>con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</span>
<span id="cb253-2"><a href="optimizing-shiny-code.html#cb253-2"></a>  RSQLite<span class="op">::</span><span class="kw">SQLite</span>(), </span>
<span id="cb253-3"><a href="optimizing-shiny-code.html#cb253-3"></a>  <span class="dt">dbname =</span> <span class="st">&quot;:memory:&quot;</span></span>
<span id="cb253-4"><a href="optimizing-shiny-code.html#cb253-4"></a>)</span>
<span id="cb253-5"><a href="optimizing-shiny-code.html#cb253-5"></a>DBI<span class="op">::</span><span class="kw">dbWriteTable</span>(</span>
<span id="cb253-6"><a href="optimizing-shiny-code.html#cb253-6"></a>  con, </span>
<span id="cb253-7"><a href="optimizing-shiny-code.html#cb253-7"></a>  <span class="st">&quot;diams&quot;</span>, </span>
<span id="cb253-8"><a href="optimizing-shiny-code.html#cb253-8"></a>  dplyr<span class="op">::</span><span class="kw">bind_rows</span>(</span>
<span id="cb253-9"><a href="optimizing-shiny-code.html#cb253-9"></a>    purrr<span class="op">::</span><span class="kw">rerun</span>(<span class="dv">100</span>, ggplot2<span class="op">::</span>diamonds)</span>
<span id="cb253-10"><a href="optimizing-shiny-code.html#cb253-10"></a>  )</span>
<span id="cb253-11"><a href="optimizing-shiny-code.html#cb253-11"></a>)</span>
<span id="cb253-12"><a href="optimizing-shiny-code.html#cb253-12"></a></span>
<span id="cb253-13"><a href="optimizing-shiny-code.html#cb253-13"></a>fct_sql &lt;-<span class="st"> </span><span class="cf">function</span>(cut, con){</span>
<span id="cb253-14"><a href="optimizing-shiny-code.html#cb253-14"></a>  <span class="co"># NEVER EVER SPRINTF AN SQL CODE LIKE THAT</span></span>
<span id="cb253-15"><a href="optimizing-shiny-code.html#cb253-15"></a>  <span class="co"># IT&#39;S SENSITIVE TO SQL INJECTIONS, WE&#39;RE</span></span>
<span id="cb253-16"><a href="optimizing-shiny-code.html#cb253-16"></a>  <span class="co"># DOING IT FOR THE EXAMPLE</span></span>
<span id="cb253-17"><a href="optimizing-shiny-code.html#cb253-17"></a>  DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</span>
<span id="cb253-18"><a href="optimizing-shiny-code.html#cb253-18"></a>    con, <span class="kw">sprintf</span>(</span>
<span id="cb253-19"><a href="optimizing-shiny-code.html#cb253-19"></a>      <span class="st">&quot;SELECT * FROM diams WHERE cut = &#39;%s&#39;&quot;</span>, </span>
<span id="cb253-20"><a href="optimizing-shiny-code.html#cb253-20"></a>      cut</span>
<span id="cb253-21"><a href="optimizing-shiny-code.html#cb253-21"></a>    )</span>
<span id="cb253-22"><a href="optimizing-shiny-code.html#cb253-22"></a>  )  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</span>
<span id="cb253-23"><a href="optimizing-shiny-code.html#cb253-23"></a>}</span>
<span id="cb253-24"><a href="optimizing-shiny-code.html#cb253-24"></a>db &lt;-<span class="st"> </span><span class="kw">cache_filesystem</span>(<span class="st">&quot;cache/&quot;</span>)</span>
<span id="cb253-25"><a href="optimizing-shiny-code.html#cb253-25"></a>fct_sql &lt;-<span class="st"> </span><span class="kw">memoise</span>(fct_sql, <span class="dt">cache =</span> db)</span>
<span id="cb253-26"><a href="optimizing-shiny-code.html#cb253-26"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb253-27"><a href="optimizing-shiny-code.html#cb253-27"></a>  <span class="kw">tagList</span>(</span>
<span id="cb253-28"><a href="optimizing-shiny-code.html#cb253-28"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;cut&quot;</span>, <span class="st">&quot;cut&quot;</span>, <span class="kw">unique</span>(ggplot2<span class="op">::</span>diamonds<span class="op">$</span>cut)),</span>
<span id="cb253-29"><a href="optimizing-shiny-code.html#cb253-29"></a>    <span class="kw">tableOutput</span>(<span class="st">&quot;tbl&quot;</span>)</span>
<span id="cb253-30"><a href="optimizing-shiny-code.html#cb253-30"></a>  )</span>
<span id="cb253-31"><a href="optimizing-shiny-code.html#cb253-31"></a>}</span>
<span id="cb253-32"><a href="optimizing-shiny-code.html#cb253-32"></a></span>
<span id="cb253-33"><a href="optimizing-shiny-code.html#cb253-33"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb253-34"><a href="optimizing-shiny-code.html#cb253-34"></a>  input, </span>
<span id="cb253-35"><a href="optimizing-shiny-code.html#cb253-35"></a>  output, </span>
<span id="cb253-36"><a href="optimizing-shiny-code.html#cb253-36"></a>  session</span>
<span id="cb253-37"><a href="optimizing-shiny-code.html#cb253-37"></a>){</span>
<span id="cb253-38"><a href="optimizing-shiny-code.html#cb253-38"></a>  </span>
<span id="cb253-39"><a href="optimizing-shiny-code.html#cb253-39"></a>  output<span class="op">$</span>tbl &lt;-<span class="st"> </span><span class="kw">renderTable</span>({</span>
<span id="cb253-40"><a href="optimizing-shiny-code.html#cb253-40"></a>    <span class="kw">fct_sql</span>(input<span class="op">$</span>cut, con)</span>
<span id="cb253-41"><a href="optimizing-shiny-code.html#cb253-41"></a>  })</span>
<span id="cb253-42"><a href="optimizing-shiny-code.html#cb253-42"></a>  </span>
<span id="cb253-43"><a href="optimizing-shiny-code.html#cb253-43"></a>}</span>
<span id="cb253-44"><a href="optimizing-shiny-code.html#cb253-44"></a></span>
<span id="cb253-45"><a href="optimizing-shiny-code.html#cb253-45"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>You will see that the first time you run this piece of code, it will take a couple of seconds to render the table for a new <code>input$cut</code> value.
But if you re-select this input a second time, the output will show instantaneously.</p>
<p>Caching is a nice way to make your app faster: even more if you expect your output to be stable over time: if the plot created by a series of inputs stays the same all along your app lifecycle, it is worth thinking about implementing an on-disk caching.
At the time of writing these lines (April 2020), you can also use remote caching, in the form of Amazon S3 storage or with Google Cloud Storage.
To do that, you will need the development version of <code>{memoise}</code> (version 1.1.0).</p>
<p>If your application needs “fresh” data every time it is used, for example because data in the SQL database are updated every hour, cache will not be of much help here, on the contrary: the same inputs on the function will render different output depending on when they are called.</p>
<p>One other thing to remember is that, just like our computer screen from our phone number example from before, you do not have unlimited space when it come to storing cache: storing a large amount of cache will take space on your disk.</p>
<p>For example, from our stored cache from before:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="optimizing-shiny-code.html#cb254-1"></a>fs<span class="op">::</span><span class="kw">dir_info</span>(tpd)[, <span class="st">&quot;size&quot;</span>]</span></code></pre></div>
<pre><code>  1.86M 462.31K</code></pre>
<p>Managing cache at a system level is out of scope for this book, but note that the most commonly accepted rule for deleting cache is called <strong>LRU</strong>, for <strong>Least Recently Used</strong>.
The underlying principle of this approach is that users tend to need what they have needed recently: hence the more a piece of data has been used recently, the more likely it is that it will be needed soon.</p>
<p>And this can be retrieved with:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="optimizing-shiny-code.html#cb256-1"></a>fs<span class="op">::</span><span class="kw">dir_info</span>(tpd)[, <span class="st">&quot;access_time&quot;</span>]</span></code></pre></div>
<pre><code>[1] &quot;2020-04-27 20:30:07 UTC&quot; &quot;2020-04-27 20:30:02 UTC&quot;</code></pre>
<p>Hence, when using cache, it might be interesting to periodically removed the oldest used cache, so that you can regain some space on the server running the application.</p>
</div>
</div>
<div id="asynchronous-in-shiny" class="section level2">
<h2><span class="header-section-number">17.3</span> Asynchronous in Shiny</h2>
<p>One of the drawbacks of Shiny is that as it is running on top of R, it is single threaded: meaning that each computation is run in sequence, one after the other.
Well, at least natively, as methods have emerged to run pieces of code in parallel.</p>
<div id="how-to" class="section level3">
<h3><span class="header-section-number">17.3.1</span> How to</h3>
<p>To launch code blocks in parallel, we will use a combination of two packages, <code>{future}</code> <span class="citation">(Bengtsson <a href="#ref-R-future" role="doc-biblioref">2020</a>)</span> and <code>{promises}</code> <span class="citation">(Cheng <a href="#ref-R-promises" role="doc-biblioref">2019</a>)</span>, and a <code>reactiveValue()</code>.
<code>{future}</code> is an R package which main purpose is to allow users to send code to be run elsewhere, i.e in another session, thread, or even on another machine.
<code>{promises}</code>, on the other hand, is a package providing structure for handling asynchronous programming in R.<a href="#fn44" class="footnote-ref" id="fnref44"><sup>44</sup></a></p>
<div id="asynchronous-for-cross-sessions-availability" class="section level4">
<h4><span class="header-section-number">17.3.1.1</span> Asynchronous for Cross-sessions Availability</h4>
<p>The first type of asynchronous programming in Shiny is the one that allow non-blocking programming at a cross-session context.
In other words, it is a programming method which is useful in the context of running one Shiny session which is accessed by multiple users.
Natively, in Shiny, if user1 comes and launches a 15 second computation, then user2 has to wait for this computation to finish, before launching their own 15 second computation, and user 3 has to wait the 15 seconds of user1 plus the 15 seconds for user, etc.</p>
<p>With <code>{future}</code> and <code>{promises}</code>, each long computation is sent to be run somewhere else, so when user1 launches their 15 second computation, they are not blocking the R process for user2 and user3.</p>
<p>How does it work?<a href="#fn45" class="footnote-ref" id="fnref45"><sup>45</sup></a>
<code>{promises}</code> comes with two operators which will be useful in our case, <code>%...&gt;%</code> and <code>%...!%</code>: the first being “what happens when the <code>future()</code> is solved?” (i.e. when the computation from the <code>future()</code> is completed), and the second is “what happens if the <code>future()</code> fails?” (i.e. what to do when the <code>future()</code> returns an error).</p>
<p>Here is an example of using this skeleton:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="optimizing-shiny-code.html#cb258-1"></a><span class="kw">library</span>(future)</span>
<span id="cb258-2"><a href="optimizing-shiny-code.html#cb258-2"></a><span class="kw">library</span>(promises)</span>
<span id="cb258-3"><a href="optimizing-shiny-code.html#cb258-3"></a><span class="kw">plan</span>(multisession) <span class="co"># We&#39;re opening several R session (future specific)</span></span>
<span id="cb258-4"><a href="optimizing-shiny-code.html#cb258-4"></a><span class="kw">future</span>({</span>
<span id="cb258-5"><a href="optimizing-shiny-code.html#cb258-5"></a>  <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb258-6"><a href="optimizing-shiny-code.html#cb258-6"></a>  <span class="kw">return</span>(<span class="kw">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb258-7"><a href="optimizing-shiny-code.html#cb258-7"></a>}) <span class="op">%...&gt;%</span><span class="st"> </span>(</span>
<span id="cb258-8"><a href="optimizing-shiny-code.html#cb258-8"></a>  <span class="cf">function</span>(result){</span>
<span id="cb258-9"><a href="optimizing-shiny-code.html#cb258-9"></a>    <span class="kw">print</span>(result)</span>
<span id="cb258-10"><a href="optimizing-shiny-code.html#cb258-10"></a>  }</span>
<span id="cb258-11"><a href="optimizing-shiny-code.html#cb258-11"></a>) <span class="op">%...!%</span><span class="st"> </span>(</span>
<span id="cb258-12"><a href="optimizing-shiny-code.html#cb258-12"></a>  <span class="cf">function</span>(error){</span>
<span id="cb258-13"><a href="optimizing-shiny-code.html#cb258-13"></a>    <span class="kw">stop</span>(error)</span>
<span id="cb258-14"><a href="optimizing-shiny-code.html#cb258-14"></a>  }</span>
<span id="cb258-15"><a href="optimizing-shiny-code.html#cb258-15"></a>)</span></code></pre></div>
<p>If you run this in your console, you will see that you have access to the R console directly after launching the code.
And a couple of seconds later (a little bit more than 3), the result of the <code>rnorm(5)</code> will be printed to the console.</p>
<p>Note that you can also write one-line function with <code>.</code> as a parameter, instead of building the full anonymous function (we will use this notation in the rest of the chapter):</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="optimizing-shiny-code.html#cb259-1"></a><span class="kw">library</span>(future)</span>
<span id="cb259-2"><a href="optimizing-shiny-code.html#cb259-2"></a><span class="kw">library</span>(promises)</span>
<span id="cb259-3"><a href="optimizing-shiny-code.html#cb259-3"></a><span class="kw">plan</span>(multisession) <span class="co"># We&#39;re opening several R session (future specific)</span></span>
<span id="cb259-4"><a href="optimizing-shiny-code.html#cb259-4"></a><span class="kw">future</span>({</span>
<span id="cb259-5"><a href="optimizing-shiny-code.html#cb259-5"></a>  <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb259-6"><a href="optimizing-shiny-code.html#cb259-6"></a>  <span class="kw">return</span>(<span class="kw">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb259-7"><a href="optimizing-shiny-code.html#cb259-7"></a>}) <span class="op">%...&gt;%</span><span class="st"> </span></span>
<span id="cb259-8"><a href="optimizing-shiny-code.html#cb259-8"></a><span class="st">  </span><span class="kw">print</span>(.) <span class="op">%...!%</span><span class="st"> </span></span>
<span id="cb259-9"><a href="optimizing-shiny-code.html#cb259-9"></a><span class="st">  </span><span class="kw">stop</span>(.)</span></code></pre></div>
<p>Let’s port this to Shiny:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="optimizing-shiny-code.html#cb260-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb260-2"><a href="optimizing-shiny-code.html#cb260-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb260-3"><a href="optimizing-shiny-code.html#cb260-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb260-4"><a href="optimizing-shiny-code.html#cb260-4"></a>    <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;pr&quot;</span>)</span>
<span id="cb260-5"><a href="optimizing-shiny-code.html#cb260-5"></a>  )</span>
<span id="cb260-6"><a href="optimizing-shiny-code.html#cb260-6"></a>}</span>
<span id="cb260-7"><a href="optimizing-shiny-code.html#cb260-7"></a></span>
<span id="cb260-8"><a href="optimizing-shiny-code.html#cb260-8"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb260-9"><a href="optimizing-shiny-code.html#cb260-9"></a>  input, </span>
<span id="cb260-10"><a href="optimizing-shiny-code.html#cb260-10"></a>  output, </span>
<span id="cb260-11"><a href="optimizing-shiny-code.html#cb260-11"></a>  session</span>
<span id="cb260-12"><a href="optimizing-shiny-code.html#cb260-12"></a>){</span>
<span id="cb260-13"><a href="optimizing-shiny-code.html#cb260-13"></a>  output<span class="op">$</span>pr &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({</span>
<span id="cb260-14"><a href="optimizing-shiny-code.html#cb260-14"></a>    <span class="kw">future</span>({</span>
<span id="cb260-15"><a href="optimizing-shiny-code.html#cb260-15"></a>      <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb260-16"><a href="optimizing-shiny-code.html#cb260-16"></a>      <span class="kw">return</span>(<span class="kw">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb260-17"><a href="optimizing-shiny-code.html#cb260-17"></a>    }) <span class="op">%...&gt;%</span><span class="st"> </span></span>
<span id="cb260-18"><a href="optimizing-shiny-code.html#cb260-18"></a><span class="st">      </span><span class="kw">print</span>(.) <span class="op">%...!%</span><span class="st"> </span></span>
<span id="cb260-19"><a href="optimizing-shiny-code.html#cb260-19"></a><span class="st">      </span><span class="kw">stop</span>(.)</span>
<span id="cb260-20"><a href="optimizing-shiny-code.html#cb260-20"></a>  })</span>
<span id="cb260-21"><a href="optimizing-shiny-code.html#cb260-21"></a>}</span>
<span id="cb260-22"><a href="optimizing-shiny-code.html#cb260-22"></a></span>
<span id="cb260-23"><a href="optimizing-shiny-code.html#cb260-23"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>If you have run this, that does not seem like a revolution: but trust us, the <code>Sys.sleep()</code> is not blocking as it allows other users to launch the same computation at the same moment.</p>
</div>
<div id="inner-session-asynchronousity" class="section level4">
<h4><span class="header-section-number">17.3.1.2</span> Inner-session Asynchronousity</h4>
<p>In the previous section we have implemented cross-session asynchronousity, meaning that the code is non-blocking but for when two or more users access the same app: the code is still blocking at an inner-session level.</p>
<p>Let’s have a look at this code:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="optimizing-shiny-code.html#cb261-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb261-2"><a href="optimizing-shiny-code.html#cb261-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb261-3"><a href="optimizing-shiny-code.html#cb261-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb261-4"><a href="optimizing-shiny-code.html#cb261-4"></a>    <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;pr&quot;</span>), </span>
<span id="cb261-5"><a href="optimizing-shiny-code.html#cb261-5"></a>    <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb261-6"><a href="optimizing-shiny-code.html#cb261-6"></a>  )</span>
<span id="cb261-7"><a href="optimizing-shiny-code.html#cb261-7"></a>}</span>
<span id="cb261-8"><a href="optimizing-shiny-code.html#cb261-8"></a></span>
<span id="cb261-9"><a href="optimizing-shiny-code.html#cb261-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb261-10"><a href="optimizing-shiny-code.html#cb261-10"></a>  input, </span>
<span id="cb261-11"><a href="optimizing-shiny-code.html#cb261-11"></a>  output, </span>
<span id="cb261-12"><a href="optimizing-shiny-code.html#cb261-12"></a>  session</span>
<span id="cb261-13"><a href="optimizing-shiny-code.html#cb261-13"></a>){</span>
<span id="cb261-14"><a href="optimizing-shiny-code.html#cb261-14"></a>  output<span class="op">$</span>pr &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({</span>
<span id="cb261-15"><a href="optimizing-shiny-code.html#cb261-15"></a>    <span class="kw">future</span>({</span>
<span id="cb261-16"><a href="optimizing-shiny-code.html#cb261-16"></a>      <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb261-17"><a href="optimizing-shiny-code.html#cb261-17"></a>      <span class="kw">return</span>(<span class="kw">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb261-18"><a href="optimizing-shiny-code.html#cb261-18"></a>    }) <span class="op">%...&gt;%</span><span class="st"> </span></span>
<span id="cb261-19"><a href="optimizing-shiny-code.html#cb261-19"></a><span class="st">      </span><span class="kw">print</span>(.) <span class="op">%...!%</span><span class="st"> </span></span>
<span id="cb261-20"><a href="optimizing-shiny-code.html#cb261-20"></a><span class="st">      </span><span class="kw">stop</span>(.)</span>
<span id="cb261-21"><a href="optimizing-shiny-code.html#cb261-21"></a>  })</span>
<span id="cb261-22"><a href="optimizing-shiny-code.html#cb261-22"></a>  </span>
<span id="cb261-23"><a href="optimizing-shiny-code.html#cb261-23"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb261-24"><a href="optimizing-shiny-code.html#cb261-24"></a>    <span class="kw">plot</span>(iris)</span>
<span id="cb261-25"><a href="optimizing-shiny-code.html#cb261-25"></a>  })</span>
<span id="cb261-26"><a href="optimizing-shiny-code.html#cb261-26"></a>}</span>
<span id="cb261-27"><a href="optimizing-shiny-code.html#cb261-27"></a></span>
<span id="cb261-28"><a href="optimizing-shiny-code.html#cb261-28"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Here, you would expect the plot to be available before the <code>rnorm()</code>, but it is not: <code>{promises}</code> is still blocking at an inner-session level, so elements are still rendered sequentially.
To bypass that, we will use a <code>reactiveValue()</code> structure.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="optimizing-shiny-code.html#cb262-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb262-2"><a href="optimizing-shiny-code.html#cb262-2"></a><span class="kw">library</span>(promises)</span>
<span id="cb262-3"><a href="optimizing-shiny-code.html#cb262-3"></a><span class="kw">library</span>(future)</span>
<span id="cb262-4"><a href="optimizing-shiny-code.html#cb262-4"></a><span class="kw">plan</span>(multisession)</span>
<span id="cb262-5"><a href="optimizing-shiny-code.html#cb262-5"></a></span>
<span id="cb262-6"><a href="optimizing-shiny-code.html#cb262-6"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb262-7"><a href="optimizing-shiny-code.html#cb262-7"></a>  <span class="kw">tagList</span>(</span>
<span id="cb262-8"><a href="optimizing-shiny-code.html#cb262-8"></a>    <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;pr&quot;</span>), </span>
<span id="cb262-9"><a href="optimizing-shiny-code.html#cb262-9"></a>    <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb262-10"><a href="optimizing-shiny-code.html#cb262-10"></a>  )</span>
<span id="cb262-11"><a href="optimizing-shiny-code.html#cb262-11"></a>}</span>
<span id="cb262-12"><a href="optimizing-shiny-code.html#cb262-12"></a></span>
<span id="cb262-13"><a href="optimizing-shiny-code.html#cb262-13"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb262-14"><a href="optimizing-shiny-code.html#cb262-14"></a>  input, </span>
<span id="cb262-15"><a href="optimizing-shiny-code.html#cb262-15"></a>  output, </span>
<span id="cb262-16"><a href="optimizing-shiny-code.html#cb262-16"></a>  session</span>
<span id="cb262-17"><a href="optimizing-shiny-code.html#cb262-17"></a>) {</span>
<span id="cb262-18"><a href="optimizing-shiny-code.html#cb262-18"></a>  </span>
<span id="cb262-19"><a href="optimizing-shiny-code.html#cb262-19"></a>  rv &lt;-<span class="st"> </span><span class="kw">reactiveValues</span>(</span>
<span id="cb262-20"><a href="optimizing-shiny-code.html#cb262-20"></a>    <span class="dt">res =</span> <span class="ot">NULL</span></span>
<span id="cb262-21"><a href="optimizing-shiny-code.html#cb262-21"></a>  )</span>
<span id="cb262-22"><a href="optimizing-shiny-code.html#cb262-22"></a>  </span>
<span id="cb262-23"><a href="optimizing-shiny-code.html#cb262-23"></a>  <span class="kw">future</span>({</span>
<span id="cb262-24"><a href="optimizing-shiny-code.html#cb262-24"></a>    <span class="kw">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb262-25"><a href="optimizing-shiny-code.html#cb262-25"></a>    <span class="kw">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb262-26"><a href="optimizing-shiny-code.html#cb262-26"></a>  }) <span class="op">%...&gt;%</span></span>
<span id="cb262-27"><a href="optimizing-shiny-code.html#cb262-27"></a><span class="st">    </span>(<span class="cf">function</span>(e){</span>
<span id="cb262-28"><a href="optimizing-shiny-code.html#cb262-28"></a>      rv<span class="op">$</span>res &lt;-<span class="st"> </span>e</span>
<span id="cb262-29"><a href="optimizing-shiny-code.html#cb262-29"></a>    }) <span class="op">%...!%</span></span>
<span id="cb262-30"><a href="optimizing-shiny-code.html#cb262-30"></a><span class="st">    </span>(<span class="cf">function</span>(e){</span>
<span id="cb262-31"><a href="optimizing-shiny-code.html#cb262-31"></a>      rv<span class="op">$</span>res &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb262-32"><a href="optimizing-shiny-code.html#cb262-32"></a>      <span class="kw">warning</span>(e)</span>
<span id="cb262-33"><a href="optimizing-shiny-code.html#cb262-33"></a>    })</span>
<span id="cb262-34"><a href="optimizing-shiny-code.html#cb262-34"></a>  </span>
<span id="cb262-35"><a href="optimizing-shiny-code.html#cb262-35"></a>  output<span class="op">$</span>pr &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({</span>
<span id="cb262-36"><a href="optimizing-shiny-code.html#cb262-36"></a>    <span class="kw">req</span>(rv<span class="op">$</span>res)</span>
<span id="cb262-37"><a href="optimizing-shiny-code.html#cb262-37"></a>  })</span>
<span id="cb262-38"><a href="optimizing-shiny-code.html#cb262-38"></a>  </span>
<span id="cb262-39"><a href="optimizing-shiny-code.html#cb262-39"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb262-40"><a href="optimizing-shiny-code.html#cb262-40"></a>    <span class="kw">plot</span>(iris)</span>
<span id="cb262-41"><a href="optimizing-shiny-code.html#cb262-41"></a>  })</span>
<span id="cb262-42"><a href="optimizing-shiny-code.html#cb262-42"></a>}</span>
<span id="cb262-43"><a href="optimizing-shiny-code.html#cb262-43"></a></span>
<span id="cb262-44"><a href="optimizing-shiny-code.html#cb262-44"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Let’s detail this code step by step:</p>
<ul>
<li><p><code>rv &lt;- reactiveValues</code> creates a <code>reactiveValue()</code> that will contains <code>NULL</code>, and which will serve the content of <code>renderPrint()</code> when the <code>future()</code> is resolved.
It is initiated as <code>NULL</code> so that the <code>renderPrint()</code> is silent at launch.</p></li>
<li><p><code>%...&gt;% rv() %...!%</code> is the <code>{promises}</code> structure we have seen before.</p></li>
<li><p><code>%...!% (function(e){ rv$res &lt;- NULL ; warning(e) })</code> is what happens when the <code>future({})</code> fails: we are setting the <code>rv$res</code> value back to <code>NULL</code> so that the <code>renderPrint()</code> does not fails and print an error in case of failure.</p></li>
</ul>
</div>
<div id="potential-pitfalls-of-asynchronous-shiny" class="section level4">
<h4><span class="header-section-number">17.3.1.3</span> Potential Pitfalls of Asynchronous Shiny</h4>
<p>There is one thing to be aware of if you plan on using this async methodology: that you are not in a sequential context anymore.
What that implies is that the first <code>future({})</code> you will send is not necessary the first you will get back.
For example, if you send SQL requests to be run asynchronically and that each call takes between 1 an 10 seconds to return, there is a chance that the first request to return will be the last one you have sent.</p>
<p>To handle that, we can adopt two different strategies, depending on what we need:</p>
<ul>
<li>We need only the last expression sent.
In other words, if we send three expressions to be evaluated somewhere, we only need to get back the last one.<br />
To handle that, the best way is to have an id that is also sent to the future, and when the future comes back, we check that this id is the one we are expecting.
If it is, we update the <code>reactiveValues()</code>.
If it is not, we ignore it.</li>
</ul>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="optimizing-shiny-code.html#cb263-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb263-2"><a href="optimizing-shiny-code.html#cb263-2"></a><span class="kw">library</span>(promises)</span>
<span id="cb263-3"><a href="optimizing-shiny-code.html#cb263-3"></a><span class="kw">library</span>(future)</span>
<span id="cb263-4"><a href="optimizing-shiny-code.html#cb263-4"></a><span class="kw">plan</span>(multisession)</span>
<span id="cb263-5"><a href="optimizing-shiny-code.html#cb263-5"></a></span>
<span id="cb263-6"><a href="optimizing-shiny-code.html#cb263-6"></a></span>
<span id="cb263-7"><a href="optimizing-shiny-code.html#cb263-7"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb263-8"><a href="optimizing-shiny-code.html#cb263-8"></a>  <span class="kw">tagList</span>(</span>
<span id="cb263-9"><a href="optimizing-shiny-code.html#cb263-9"></a>    <span class="kw">actionButton</span>(<span class="st">&quot;go&quot;</span>, <span class="st">&quot;go&quot;</span>),</span>
<span id="cb263-10"><a href="optimizing-shiny-code.html#cb263-10"></a>    <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;pr&quot;</span>), </span>
<span id="cb263-11"><a href="optimizing-shiny-code.html#cb263-11"></a>    <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb263-12"><a href="optimizing-shiny-code.html#cb263-12"></a>  )</span>
<span id="cb263-13"><a href="optimizing-shiny-code.html#cb263-13"></a>}</span>
<span id="cb263-14"><a href="optimizing-shiny-code.html#cb263-14"></a></span>
<span id="cb263-15"><a href="optimizing-shiny-code.html#cb263-15"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb263-16"><a href="optimizing-shiny-code.html#cb263-16"></a>  input, </span>
<span id="cb263-17"><a href="optimizing-shiny-code.html#cb263-17"></a>  output, </span>
<span id="cb263-18"><a href="optimizing-shiny-code.html#cb263-18"></a>  session</span>
<span id="cb263-19"><a href="optimizing-shiny-code.html#cb263-19"></a>) {</span>
<span id="cb263-20"><a href="optimizing-shiny-code.html#cb263-20"></a>  </span>
<span id="cb263-21"><a href="optimizing-shiny-code.html#cb263-21"></a>  rv &lt;-<span class="st"> </span><span class="kw">reactiveValues</span>(</span>
<span id="cb263-22"><a href="optimizing-shiny-code.html#cb263-22"></a>    <span class="dt">res =</span> <span class="ot">NULL</span>, </span>
<span id="cb263-23"><a href="optimizing-shiny-code.html#cb263-23"></a>    <span class="dt">last_id =</span> <span class="dv">0</span></span>
<span id="cb263-24"><a href="optimizing-shiny-code.html#cb263-24"></a>  )</span>
<span id="cb263-25"><a href="optimizing-shiny-code.html#cb263-25"></a>  </span>
<span id="cb263-26"><a href="optimizing-shiny-code.html#cb263-26"></a>  <span class="kw">observeEvent</span>( input<span class="op">$</span>go , {</span>
<span id="cb263-27"><a href="optimizing-shiny-code.html#cb263-27"></a>    rv<span class="op">$</span>last_id &lt;-<span class="st"> </span>rv<span class="op">$</span>last_id <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb263-28"><a href="optimizing-shiny-code.html#cb263-28"></a>    last_id &lt;-<span class="st"> </span>rv<span class="op">$</span>last_id</span>
<span id="cb263-29"><a href="optimizing-shiny-code.html#cb263-29"></a>    </span>
<span id="cb263-30"><a href="optimizing-shiny-code.html#cb263-30"></a>    <span class="kw">future</span>({</span>
<span id="cb263-31"><a href="optimizing-shiny-code.html#cb263-31"></a>      <span class="cf">if</span> (last_id <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb263-32"><a href="optimizing-shiny-code.html#cb263-32"></a>        <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb263-33"><a href="optimizing-shiny-code.html#cb263-33"></a>      }</span>
<span id="cb263-34"><a href="optimizing-shiny-code.html#cb263-34"></a>      <span class="kw">list</span>(</span>
<span id="cb263-35"><a href="optimizing-shiny-code.html#cb263-35"></a>        <span class="dt">id =</span> last_id,</span>
<span id="cb263-36"><a href="optimizing-shiny-code.html#cb263-36"></a>        <span class="dt">res =</span> <span class="kw">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb263-37"><a href="optimizing-shiny-code.html#cb263-37"></a>      )</span>
<span id="cb263-38"><a href="optimizing-shiny-code.html#cb263-38"></a>    }) <span class="op">%...&gt;%</span></span>
<span id="cb263-39"><a href="optimizing-shiny-code.html#cb263-39"></a><span class="st">      </span>(<span class="cf">function</span>(e){</span>
<span id="cb263-40"><a href="optimizing-shiny-code.html#cb263-40"></a>        cli<span class="op">::</span><span class="kw">cat_rule</span>(</span>
<span id="cb263-41"><a href="optimizing-shiny-code.html#cb263-41"></a>          <span class="kw">sprintf</span>(<span class="st">&quot;Back from %s&quot;</span>, e<span class="op">$</span>id)</span>
<span id="cb263-42"><a href="optimizing-shiny-code.html#cb263-42"></a>        )</span>
<span id="cb263-43"><a href="optimizing-shiny-code.html#cb263-43"></a>        <span class="cf">if</span> (e<span class="op">$</span>id <span class="op">==</span><span class="st"> </span>rv<span class="op">$</span>last_id){</span>
<span id="cb263-44"><a href="optimizing-shiny-code.html#cb263-44"></a>          rv<span class="op">$</span>res &lt;-<span class="st"> </span>e</span>
<span id="cb263-45"><a href="optimizing-shiny-code.html#cb263-45"></a>        }</span>
<span id="cb263-46"><a href="optimizing-shiny-code.html#cb263-46"></a>      }) <span class="op">%...!%</span></span>
<span id="cb263-47"><a href="optimizing-shiny-code.html#cb263-47"></a><span class="st">      </span>(<span class="cf">function</span>(e){</span>
<span id="cb263-48"><a href="optimizing-shiny-code.html#cb263-48"></a>        rv<span class="op">$</span>res &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb263-49"><a href="optimizing-shiny-code.html#cb263-49"></a>        <span class="kw">warning</span>(e)</span>
<span id="cb263-50"><a href="optimizing-shiny-code.html#cb263-50"></a>      })</span>
<span id="cb263-51"><a href="optimizing-shiny-code.html#cb263-51"></a>    cli<span class="op">::</span><span class="kw">cat_rule</span>(</span>
<span id="cb263-52"><a href="optimizing-shiny-code.html#cb263-52"></a>      <span class="kw">sprintf</span>(<span class="st">&quot;%s sent&quot;</span>, rv<span class="op">$</span>last_id)</span>
<span id="cb263-53"><a href="optimizing-shiny-code.html#cb263-53"></a>    )</span>
<span id="cb263-54"><a href="optimizing-shiny-code.html#cb263-54"></a>  })</span>
<span id="cb263-55"><a href="optimizing-shiny-code.html#cb263-55"></a>  </span>
<span id="cb263-56"><a href="optimizing-shiny-code.html#cb263-56"></a>  output<span class="op">$</span>pr &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({</span>
<span id="cb263-57"><a href="optimizing-shiny-code.html#cb263-57"></a>    <span class="kw">req</span>(rv<span class="op">$</span>res)</span>
<span id="cb263-58"><a href="optimizing-shiny-code.html#cb263-58"></a>  })</span>
<span id="cb263-59"><a href="optimizing-shiny-code.html#cb263-59"></a>  </span>
<span id="cb263-60"><a href="optimizing-shiny-code.html#cb263-60"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb263-61"><a href="optimizing-shiny-code.html#cb263-61"></a>    <span class="kw">plot</span>(iris)</span>
<span id="cb263-62"><a href="optimizing-shiny-code.html#cb263-62"></a>  })</span>
<span id="cb263-63"><a href="optimizing-shiny-code.html#cb263-63"></a>}</span>
<span id="cb263-64"><a href="optimizing-shiny-code.html#cb263-64"></a></span>
<span id="cb263-65"><a href="optimizing-shiny-code.html#cb263-65"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<ul>
<li>We need to treat the outputs in the order they are received.
In that case, instead of waiting for the very last input, you will need to build a structure that will receive the output, check if this output is the “next in line”, store it if it is not, or return it if it is and see if there is another output in the queue.
This type of implementation is a little bit more complex so we will not detail it all inside this chapter, but here is a small implementation using <code>{liteq}</code> <span class="citation">(Csárdi <a href="#ref-R-liteq" role="doc-biblioref">2019</a>)</span>.</li>
</ul>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="optimizing-shiny-code.html#cb264-1"></a><span class="kw">library</span>(promises)</span>
<span id="cb264-2"><a href="optimizing-shiny-code.html#cb264-2"></a><span class="kw">library</span>(future)</span>
<span id="cb264-3"><a href="optimizing-shiny-code.html#cb264-3"></a><span class="kw">plan</span>(multisession)</span>
<span id="cb264-4"><a href="optimizing-shiny-code.html#cb264-4"></a></span>
<span id="cb264-5"><a href="optimizing-shiny-code.html#cb264-5"></a><span class="kw">library</span>(liteq)</span></code></pre></div>
<pre><code>
Attaching package: &#39;liteq&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:purrr&#39;:

    is_empty</code></pre>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="optimizing-shiny-code.html#cb267-1"></a>db &lt;-<span class="st"> </span><span class="kw">tempfile</span>()</span>
<span id="cb267-2"><a href="optimizing-shiny-code.html#cb267-2"></a>q &lt;-<span class="st"> </span><span class="kw">ensure_queue</span>(<span class="st">&quot;jobs&quot;</span>, <span class="dt">db =</span> db)</span>
<span id="cb267-3"><a href="optimizing-shiny-code.html#cb267-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>){</span>
<span id="cb267-4"><a href="optimizing-shiny-code.html#cb267-4"></a>  <span class="kw">future</span>({</span>
<span id="cb267-5"><a href="optimizing-shiny-code.html#cb267-5"></a>    <span class="kw">Sys.sleep</span>(<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span>))</span>
<span id="cb267-6"><a href="optimizing-shiny-code.html#cb267-6"></a>    <span class="kw">return</span>(<span class="kw">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb267-7"><a href="optimizing-shiny-code.html#cb267-7"></a>  }) <span class="op">%...&gt;%</span><span class="st"> </span></span>
<span id="cb267-8"><a href="optimizing-shiny-code.html#cb267-8"></a><span class="st">    </span>(<span class="cf">function</span>(res){</span>
<span id="cb267-9"><a href="optimizing-shiny-code.html#cb267-9"></a>      <span class="kw">publish</span>(q, <span class="dt">title =</span> <span class="kw">as.character</span>(i), <span class="dt">message =</span> <span class="kw">paste</span>(res, <span class="dt">collapse =</span> <span class="st">&quot;,&quot;</span>))</span>
<span id="cb267-10"><a href="optimizing-shiny-code.html#cb267-10"></a>    }) <span class="op">%...!%</span><span class="st"> </span></span>
<span id="cb267-11"><a href="optimizing-shiny-code.html#cb267-11"></a><span class="st">    </span><span class="kw">stop</span>(.)</span>
<span id="cb267-12"><a href="optimizing-shiny-code.html#cb267-12"></a>}</span></code></pre></div>

</div>
</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-R-R.cache">
<p>Bengtsson, Henrik. 2019. <em>R.cache: Fast and Light-Weight Caching (Memoization) of Objects and Results to Speed up Computations</em>. <a href="https://CRAN.R-project.org/package=R.cache">https://CRAN.R-project.org/package=R.cache</a>.</p>
</div>
<div id="ref-R-future">
<p>Bengtsson, Henrik. 2020. <em>Future: Unified Parallel and Distributed Processing in R for Everyone</em>. <a href="https://CRAN.R-project.org/package=future">https://CRAN.R-project.org/package=future</a>.</p>
</div>
<div id="ref-R-shiny">
<p>Chang, Winston, Joe Cheng, JJ Allaire, Yihui Xie, and Jonathan McPherson. 2020. <em>Shiny: Web Application Framework for R</em>. <a href="https://CRAN.R-project.org/package=shiny">https://CRAN.R-project.org/package=shiny</a>.</p>
</div>
<div id="ref-R-promises">
<p>Cheng, Joe. 2019. <em>Promises: Abstractions for Promise-Based Asynchronous Programming</em>. <a href="https://CRAN.R-project.org/package=promises">https://CRAN.R-project.org/package=promises</a>.</p>
</div>
<div id="ref-R-liteq">
<p>Csárdi, Gábor. 2019. <em>Liteq: Lightweight Portable Message Queue Using ’Sqlite’</em>. <a href="https://CRAN.R-project.org/package=liteq">https://CRAN.R-project.org/package=liteq</a>.</p>
</div>
<div id="ref-colingillespie2017">
<p>Gillespie, Colin, and Robin Lovelace. 2017. <em>Efficient R Programming</em>. O’Reilly Media, Inc, USA.</p>
</div>
<div id="ref-R-RSQLite">
<p>Müller, Kirill, Hadley Wickham, David A. James, and Seth Falcon. 2020. <em>RSQLite: ’SQLite’ Interface for R</em>. <a href="https://CRAN.R-project.org/package=RSQLite">https://CRAN.R-project.org/package=RSQLite</a>.</p>
</div>
<div id="ref-R-DBI">
<p>R Special Interest Group on Databases (R-SIG-DB), Hadley Wickham, and Kirill Müller. 2019. <em>DBI: R Database Interface</em>. <a href="https://CRAN.R-project.org/package=DBI">https://CRAN.R-project.org/package=DBI</a>.</p>
</div>
<div id="ref-hadleywickham2019">
<p>Wickham, Hadley. 2019. <em>Advanced R, Second Edition (Chapman &amp; Hall/Crc the R Series)</em>. Chapman; Hall/CRC. <a href="https://www.xarg.org/ref/a/0815384572/">https://www.xarg.org/ref/a/0815384572/</a>.</p>
</div>
<div id="ref-R-ggplot2">
<p>Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, Kara Woo, Hiroaki Yutani, and Dewey Dunnington. 2020. <em>Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2">https://CRAN.R-project.org/package=ggplot2</a>.</p>
</div>
<div id="ref-R-memoise">
<p>Wickham, Hadley, Jim Hester, Kirill Müller, and Daniel Cook. 2017. <em>Memoise: Memoisation of Functions</em>. <a href="https://CRAN.R-project.org/package=memoise">https://CRAN.R-project.org/package=memoise</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="41">
<li id="fn41"><p>Anyway, now that we all have smartphone, who still remembers phone numbers?<a href="optimizing-shiny-code.html#fnref41" class="footnote-back">↩︎</a></p></li>
<li id="fn43"><p>In some cases you will have to configure the size policy, but in most cases the default values work just well. <a href="optimizing-shiny-code.html#fnref43" class="footnote-back">↩︎</a></p></li>
<li id="fn44"><p>If you are familiar with promises in JavaScript, <code>{promises}</code> is an implementation of this structure into R.<a href="optimizing-shiny-code.html#fnref44" class="footnote-back">↩︎</a></p></li>
<li id="fn45"><p>We’re providing a short introduction with key concepts, but for a more thorough introduction, please refer to the <a href="https://rstudio.github.io/promises/index.html">online documentation</a><a href="optimizing-shiny-code.html#fnref45" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
<hr/>
<footer>
<a href="rtask.thinkr.fr"><img src="img/logo400_129.png" alt="ThinkR Website"/></a>
</footer>
            </section>

          </div>
        </div>
      </div>
<a href="optim-caveat.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="optimjs.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ThinkR-open/building-shiny-apps-workflow/edit/master/17-optimizing-shiny-code.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
