<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 16 Common Application Caveats | Engineering Production-Grade Shiny Apps</title>
  <meta name="description" content="Chapter 16 Common Application Caveats | Engineering Production-Grade Shiny Apps" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 16 Common Application Caveats | Engineering Production-Grade Shiny Apps" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Chapter 16 Common Application Caveats | Engineering Production-Grade Shiny Apps" />
  <meta name="github-repo" content="ThinkR-open/building-shiny-apps-workflow" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 16 Common Application Caveats | Engineering Production-Grade Shiny Apps" />
  
  <meta name="twitter:description" content="Chapter 16 Common Application Caveats | Engineering Production-Grade Shiny Apps" />
  

<meta name="author" content="Colin Fay, Sébastien Rochette, Vincent Guyader, Cervan Girard" />


<meta name="date" content="2020-04-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="prev" href="when-optimize.html"/>
<link rel="next" href="optimizing-shiny-code.html"/>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149994171-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-149994171-1');
</script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/thinkr.css" type="text/css" />
<link rel="stylesheet" href="css/style_gitbook.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Engineering Production-Grade Shiny Apps</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>I Building Successful Shiny Apps</b></span></li>
<li class="chapter" data-level="1" data-path="successfulshinyapp.html"><a href="successfulshinyapp.html"><i class="fa fa-check"></i><b>1</b> About Successful Shiny Apps</a></li>
<li class="chapter" data-level="2" data-path="planning.html"><a href="planning.html"><i class="fa fa-check"></i><b>2</b> Planning Ahead</a></li>
<li class="chapter" data-level="3" data-path="structure.html"><a href="structure.html"><i class="fa fa-check"></i><b>3</b> Structuring your Project</a></li>
<li class="chapter" data-level="4" data-path="golem.html"><a href="golem.html"><i class="fa fa-check"></i><b>4</b> Introduction to <code>{golem}</code></a></li>
<li class="chapter" data-level="5" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>5</b> The workflow</a></li>
<li class="part"><span><b>II Step 1: Design</b></span></li>
<li class="chapter" data-level="6" data-path="matters.html"><a href="matters.html"><i class="fa fa-check"></i><b>6</b> UX Matters</a></li>
<li class="chapter" data-level="7" data-path="step-design.html"><a href="step-design.html"><i class="fa fa-check"></i><b>7</b> Don’t rush into coding</a></li>
<li class="chapter" data-level="8" data-path="css.html"><a href="css.html"><i class="fa fa-check"></i><b>8</b> A Gentle Introduction to CSS</a></li>
<li class="part"><span><b>III Step 2: Prototype</b></span></li>
<li class="chapter" data-level="9" data-path="setting-up-for-success-with-golem.html"><a href="setting-up-for-success-with-golem.html"><i class="fa fa-check"></i><b>9</b> Setting up for success with <code>{golem}</code></a></li>
<li class="chapter" data-level="10" data-path="stepprotopype.html"><a href="stepprotopype.html"><i class="fa fa-check"></i><b>10</b> Building an “ipsum-app”</a></li>
<li class="part"><span><b>IV Step 3: Build</b></span></li>
<li class="chapter" data-level="11" data-path="stepbuild.html"><a href="stepbuild.html"><i class="fa fa-check"></i><b>11</b> Building app with <code>{golem}</code></a></li>
<li class="part"><span><b>V Step 4: Strengthen</b></span></li>
<li class="chapter" data-level="12" data-path="step-secure.html"><a href="step-secure.html"><i class="fa fa-check"></i><b>12</b> Build yourself a safety net</a></li>
<li class="chapter" data-level="13" data-path="secure.html"><a href="secure.html"><i class="fa fa-check"></i><b>13</b> Version Control</a></li>
<li class="chapter" data-level="14" data-path="deploy-golem.html"><a href="deploy-golem.html"><i class="fa fa-check"></i><b>14</b> Deploy your application</a></li>
<li class="part"><span><b>VI Optimizing</b></span></li>
<li class="chapter" data-level="15" data-path="when-optimize.html"><a href="when-optimize.html"><i class="fa fa-check"></i><b>15</b> The Need for Optimization</a></li>
<li class="chapter" data-level="16" data-path="optim-caveat.html"><a href="optim-caveat.html"><i class="fa fa-check"></i><b>16</b> Common Application Caveats</a></li>
<li class="chapter" data-level="17" data-path="optimizing-shiny-code.html"><a href="optimizing-shiny-code.html"><i class="fa fa-check"></i><b>17</b> Optimizing Shiny Code</a></li>
<li class="chapter" data-level="18" data-path="optimjs.html"><a href="optimjs.html"><i class="fa fa-check"></i><b>18</b> Using JavaScript</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://rtask.thinkr.fr">A book by the ThinkR team</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Engineering Production-Grade Shiny Apps</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="optim-caveat" class="section level1">
<h1><span class="header-section-number">Chapter 16</span> Common Application Caveats</h1>
<div id="reactivity-anti-patterns" class="section level2">
<h2><span class="header-section-number">16.1</span> Reactivity anti-patterns</h2>
<div id="reactivity-is-awesome-until-it-is-not" class="section level3">
<h3><span class="header-section-number">16.1.1</span> Reactivity is awesome… until it is not</h3>
<p>Let’s face it, reactivity is awesome… until it is not.
Reactivity is a common source of confusion for beginners, and a common source of bugs and bottlenecks, even for seasoned Shiny developers.
Most of the time, issues come from the fact that <strong>there is too much reactivity</strong>, <em>i.e.</em> we build apps where too much things happen, and some things are updated way more often than they should, and computations are performed when they should not.</p>
<p>Of course, it is a nice feature to make everything react instantly to changes, but when building larger apps it is easy to create monsters, i.e complicated, messy reactive graphs where everything is updated too much and too often.
Or worse, we generate endless reactive loops, aka “the reactive inferno” where A invalidates B which invalidates C which invalidates A which invalidates B which invalidates C…</p>
<p>Let’s take a small example of a reactive inferno:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="optim-caveat.html#cb215-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb215-2"><a href="optim-caveat.html#cb215-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb215-3"><a href="optim-caveat.html#cb215-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb215-4"><a href="optim-caveat.html#cb215-4"></a>    <span class="kw">dateInput</span>(</span>
<span id="cb215-5"><a href="optim-caveat.html#cb215-5"></a>      <span class="st">&quot;date&quot;</span>, </span>
<span id="cb215-6"><a href="optim-caveat.html#cb215-6"></a>      <span class="st">&quot;choose a date&quot;</span></span>
<span id="cb215-7"><a href="optim-caveat.html#cb215-7"></a>    ), </span>
<span id="cb215-8"><a href="optim-caveat.html#cb215-8"></a>    <span class="kw">selectInput</span>(</span>
<span id="cb215-9"><a href="optim-caveat.html#cb215-9"></a>      <span class="st">&quot;year&quot;</span>, </span>
<span id="cb215-10"><a href="optim-caveat.html#cb215-10"></a>      <span class="st">&quot;Choose a year&quot;</span>, </span>
<span id="cb215-11"><a href="optim-caveat.html#cb215-11"></a>      <span class="dt">choices =</span> <span class="dv">2010</span><span class="op">:</span><span class="dv">2030</span></span>
<span id="cb215-12"><a href="optim-caveat.html#cb215-12"></a>    )</span>
<span id="cb215-13"><a href="optim-caveat.html#cb215-13"></a>  )</span>
<span id="cb215-14"><a href="optim-caveat.html#cb215-14"></a>}</span>
<span id="cb215-15"><a href="optim-caveat.html#cb215-15"></a></span>
<span id="cb215-16"><a href="optim-caveat.html#cb215-16"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb215-17"><a href="optim-caveat.html#cb215-17"></a>  input, </span>
<span id="cb215-18"><a href="optim-caveat.html#cb215-18"></a>  output, </span>
<span id="cb215-19"><a href="optim-caveat.html#cb215-19"></a>  session</span>
<span id="cb215-20"><a href="optim-caveat.html#cb215-20"></a>){</span>
<span id="cb215-21"><a href="optim-caveat.html#cb215-21"></a>  <span class="kw">observeEvent</span>( input<span class="op">$</span>date , {</span>
<span id="cb215-22"><a href="optim-caveat.html#cb215-22"></a>    <span class="kw">updateSelectInput</span>(</span>
<span id="cb215-23"><a href="optim-caveat.html#cb215-23"></a>      session, </span>
<span id="cb215-24"><a href="optim-caveat.html#cb215-24"></a>      <span class="st">&quot;year&quot;</span>, </span>
<span id="cb215-25"><a href="optim-caveat.html#cb215-25"></a>      <span class="dt">selected =</span> lubridate<span class="op">::</span><span class="kw">year</span>(input<span class="op">$</span>date)</span>
<span id="cb215-26"><a href="optim-caveat.html#cb215-26"></a>    )</span>
<span id="cb215-27"><a href="optim-caveat.html#cb215-27"></a>  })</span>
<span id="cb215-28"><a href="optim-caveat.html#cb215-28"></a>  </span>
<span id="cb215-29"><a href="optim-caveat.html#cb215-29"></a>  <span class="kw">observeEvent</span>( input<span class="op">$</span>year , {</span>
<span id="cb215-30"><a href="optim-caveat.html#cb215-30"></a>    <span class="kw">updateDateInput</span>(</span>
<span id="cb215-31"><a href="optim-caveat.html#cb215-31"></a>      session, </span>
<span id="cb215-32"><a href="optim-caveat.html#cb215-32"></a>      <span class="st">&quot;date&quot;</span>, </span>
<span id="cb215-33"><a href="optim-caveat.html#cb215-33"></a>      <span class="dt">value =</span> lubridate<span class="op">::</span><span class="kw">as_date</span>(</span>
<span id="cb215-34"><a href="optim-caveat.html#cb215-34"></a>        <span class="kw">sprintf</span>(<span class="st">&quot;%s-01-01&quot;</span>, input<span class="op">$</span>year)</span>
<span id="cb215-35"><a href="optim-caveat.html#cb215-35"></a>      )</span>
<span id="cb215-36"><a href="optim-caveat.html#cb215-36"></a>    )</span>
<span id="cb215-37"><a href="optim-caveat.html#cb215-37"></a>  })</span>
<span id="cb215-38"><a href="optim-caveat.html#cb215-38"></a>  </span>
<span id="cb215-39"><a href="optim-caveat.html#cb215-39"></a>}</span>
<span id="cb215-40"><a href="optim-caveat.html#cb215-40"></a></span>
<span id="cb215-41"><a href="optim-caveat.html#cb215-41"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Here, we want to handle something pretty common:</p>
<ul>
<li>The user can pick a <code>date</code> and the <code>year</code> input is updated</li>
<li>And the other way round: when the <code>year</code> input changes, the <code>date</code> is updated too</li>
</ul>
<p>But if you try to run this in your console, it will end as a reactive inferno: date update year that updates date that updates year…</p>
<p>And the more you work on your app, the more complex it gets, and the more you will be likely to end up in the reactive inferno.
In this section, we will be speaking a little bit about reactivity and how to have more control on it, and about a way to share data across modules without relying on passing along reactive objects.</p>
</div>
<div id="observe-vs-observeevent" class="section level3">
<h3><span class="header-section-number">16.1.2</span> <code>observe</code> vs <code>observeEvent</code></h3>
<p>One of the most common feature of reactive inferno is the use of <code>observe()</code> in cases where you should use <code>observeEvent</code>.
Spoiler: you should try to use <code>observeEvent()</code> as much as possible, and avoid <code>observe()</code>as much as possible.</p>
<p>At first, <code>observe()</code> seems easier to implement, and feels like a shortcut as you do not have to think about what to react to: everything gets updated without you thinking about it.
But the truth is that this stairway does not lead to heaven.</p>
<p>Let’s stop and think about <code>observe()</code> for a minute.
This function updates <strong>every time a reactive object it contains is invalidated</strong>.
Yes, this works well if you have a small amount of reactive objects in the observer, but that gets tricky whenever you start adding things a long list of things inside your <code>observe()</code>, as you might be launching a computation 10 times if your reactive scope contains 10 reactive objects that are somehow invalidated in chain.
And believe us, we have seen pieces of code where the <code>observe()</code> contains hundreds of lines of code, with reactives objects all over the place, with one <code>observe()</code> context being invalited dozens of times when one input changes in the application.</p>
<p>For example, let’s start with that:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="optim-caveat.html#cb216-1"></a><span class="co">## DO NOT DO GLOBAL VARIABLES, IT&#39;S JUST TO SIMPLIFY THE EXAMPLE</span></span>
<span id="cb216-2"><a href="optim-caveat.html#cb216-2"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb216-3"><a href="optim-caveat.html#cb216-3"></a><span class="kw">library</span>(shiny)</span>
<span id="cb216-4"><a href="optim-caveat.html#cb216-4"></a><span class="kw">library</span>(cli)</span>
<span id="cb216-5"><a href="optim-caveat.html#cb216-5"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb216-6"><a href="optim-caveat.html#cb216-6"></a>  <span class="kw">tagList</span>(</span>
<span id="cb216-7"><a href="optim-caveat.html#cb216-7"></a>    <span class="kw">textInput</span>(<span class="st">&quot;txt&quot;</span>, <span class="st">&quot;txt&quot;</span>)</span>
<span id="cb216-8"><a href="optim-caveat.html#cb216-8"></a>  )</span>
<span id="cb216-9"><a href="optim-caveat.html#cb216-9"></a>}</span>
<span id="cb216-10"><a href="optim-caveat.html#cb216-10"></a></span>
<span id="cb216-11"><a href="optim-caveat.html#cb216-11"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session){</span>
<span id="cb216-12"><a href="optim-caveat.html#cb216-12"></a>  <span class="kw">observe</span>({</span>
<span id="cb216-13"><a href="optim-caveat.html#cb216-13"></a>    i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb216-14"><a href="optim-caveat.html#cb216-14"></a>    <span class="kw">cat_rule</span>(<span class="kw">as.character</span>(i))</span>
<span id="cb216-15"><a href="optim-caveat.html#cb216-15"></a>    <span class="kw">print</span>(input<span class="op">$</span>txt)</span>
<span id="cb216-16"><a href="optim-caveat.html#cb216-16"></a>  })</span>
<span id="cb216-17"><a href="optim-caveat.html#cb216-17"></a>}</span>
<span id="cb216-18"><a href="optim-caveat.html#cb216-18"></a></span>
<span id="cb216-19"><a href="optim-caveat.html#cb216-19"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Oh, and then, let’s add a small <code>selectInput()</code>:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="optim-caveat.html#cb217-1"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb217-2"><a href="optim-caveat.html#cb217-2"></a><span class="kw">library</span>(shiny)</span>
<span id="cb217-3"><a href="optim-caveat.html#cb217-3"></a><span class="kw">library</span>(cli)</span>
<span id="cb217-4"><a href="optim-caveat.html#cb217-4"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb217-5"><a href="optim-caveat.html#cb217-5"></a>  <span class="kw">tagList</span>(</span>
<span id="cb217-6"><a href="optim-caveat.html#cb217-6"></a>    <span class="kw">textInput</span>(<span class="st">&quot;txt&quot;</span>, <span class="st">&quot;txt&quot;</span>), </span>
<span id="cb217-7"><a href="optim-caveat.html#cb217-7"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;tolower&quot;</span>, <span class="st">&quot;casse&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>))</span>
<span id="cb217-8"><a href="optim-caveat.html#cb217-8"></a>  )</span>
<span id="cb217-9"><a href="optim-caveat.html#cb217-9"></a>}</span>
<span id="cb217-10"><a href="optim-caveat.html#cb217-10"></a></span>
<span id="cb217-11"><a href="optim-caveat.html#cb217-11"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session){</span>
<span id="cb217-12"><a href="optim-caveat.html#cb217-12"></a>  <span class="kw">observe</span>({</span>
<span id="cb217-13"><a href="optim-caveat.html#cb217-13"></a>    i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb217-14"><a href="optim-caveat.html#cb217-14"></a>    <span class="kw">cat_rule</span>(<span class="kw">as.character</span>(i))</span>
<span id="cb217-15"><a href="optim-caveat.html#cb217-15"></a>    <span class="cf">if</span> (input<span class="op">$</span>tolower <span class="op">==</span><span class="st"> &quot;lower&quot;</span>) {</span>
<span id="cb217-16"><a href="optim-caveat.html#cb217-16"></a>      <span class="kw">print</span>(<span class="kw">tolower</span>(input<span class="op">$</span>txt))</span>
<span id="cb217-17"><a href="optim-caveat.html#cb217-17"></a>    } <span class="cf">else</span>  {</span>
<span id="cb217-18"><a href="optim-caveat.html#cb217-18"></a>      <span class="kw">print</span>(<span class="kw">tolower</span>(input<span class="op">$</span>txt))</span>
<span id="cb217-19"><a href="optim-caveat.html#cb217-19"></a>    }</span>
<span id="cb217-20"><a href="optim-caveat.html#cb217-20"></a>  })</span>
<span id="cb217-21"><a href="optim-caveat.html#cb217-21"></a>}</span>
<span id="cb217-22"><a href="optim-caveat.html#cb217-22"></a></span>
<span id="cb217-23"><a href="optim-caveat.html#cb217-23"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>And, as time goes by, we add another control flow to our <code>observe()</code>:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="optim-caveat.html#cb218-1"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb218-2"><a href="optim-caveat.html#cb218-2"></a><span class="kw">library</span>(shiny)</span>
<span id="cb218-3"><a href="optim-caveat.html#cb218-3"></a><span class="kw">library</span>(cli)</span>
<span id="cb218-4"><a href="optim-caveat.html#cb218-4"></a><span class="kw">library</span>(stringi)</span>
<span id="cb218-5"><a href="optim-caveat.html#cb218-5"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb218-6"><a href="optim-caveat.html#cb218-6"></a>  <span class="kw">tagList</span>(</span>
<span id="cb218-7"><a href="optim-caveat.html#cb218-7"></a>    <span class="kw">textInput</span>(<span class="st">&quot;txt&quot;</span>, <span class="st">&quot;txt&quot;</span>), </span>
<span id="cb218-8"><a href="optim-caveat.html#cb218-8"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;tolower&quot;</span>, <span class="st">&quot;casse&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)), </span>
<span id="cb218-9"><a href="optim-caveat.html#cb218-9"></a>    <span class="kw">checkboxInput</span>(<span class="st">&quot;rev&quot;</span>, <span class="st">&quot;reverse&quot;</span>)</span>
<span id="cb218-10"><a href="optim-caveat.html#cb218-10"></a>  )</span>
<span id="cb218-11"><a href="optim-caveat.html#cb218-11"></a>}</span>
<span id="cb218-12"><a href="optim-caveat.html#cb218-12"></a></span>
<span id="cb218-13"><a href="optim-caveat.html#cb218-13"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session){</span>
<span id="cb218-14"><a href="optim-caveat.html#cb218-14"></a>  <span class="kw">observe</span>({</span>
<span id="cb218-15"><a href="optim-caveat.html#cb218-15"></a>    i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb218-16"><a href="optim-caveat.html#cb218-16"></a>    <span class="kw">cat_rule</span>(<span class="kw">as.character</span>(i))</span>
<span id="cb218-17"><a href="optim-caveat.html#cb218-17"></a>    <span class="cf">if</span> (input<span class="op">$</span>rev){</span>
<span id="cb218-18"><a href="optim-caveat.html#cb218-18"></a>      x &lt;-<span class="st"> </span><span class="kw">stri_reverse</span>(input<span class="op">$</span>txt)</span>
<span id="cb218-19"><a href="optim-caveat.html#cb218-19"></a>    } <span class="cf">else</span> {</span>
<span id="cb218-20"><a href="optim-caveat.html#cb218-20"></a>      x &lt;-<span class="st"> </span>input<span class="op">$</span>txt</span>
<span id="cb218-21"><a href="optim-caveat.html#cb218-21"></a>    }</span>
<span id="cb218-22"><a href="optim-caveat.html#cb218-22"></a>    <span class="cf">if</span> (input<span class="op">$</span>tolower <span class="op">==</span><span class="st"> &quot;lower&quot;</span>){</span>
<span id="cb218-23"><a href="optim-caveat.html#cb218-23"></a>      <span class="kw">print</span>(<span class="kw">tolower</span>(x))</span>
<span id="cb218-24"><a href="optim-caveat.html#cb218-24"></a>    } <span class="cf">else</span> {</span>
<span id="cb218-25"><a href="optim-caveat.html#cb218-25"></a>      <span class="kw">print</span>(<span class="kw">tolower</span>(x))</span>
<span id="cb218-26"><a href="optim-caveat.html#cb218-26"></a>    }</span>
<span id="cb218-27"><a href="optim-caveat.html#cb218-27"></a>  })</span>
<span id="cb218-28"><a href="optim-caveat.html#cb218-28"></a>}</span>
<span id="cb218-29"><a href="optim-caveat.html#cb218-29"></a></span>
<span id="cb218-30"><a href="optim-caveat.html#cb218-30"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>And it would be nice to keep the selected values into a reactive list, so that we can reuse it elsewhere.
And maybe you would like to add a checkbox so that the logs are printed to the console only if checked.</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="optim-caveat.html#cb219-1"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb219-2"><a href="optim-caveat.html#cb219-2"></a><span class="kw">library</span>(shiny)</span>
<span id="cb219-3"><a href="optim-caveat.html#cb219-3"></a><span class="kw">library</span>(cli)</span>
<span id="cb219-4"><a href="optim-caveat.html#cb219-4"></a><span class="kw">library</span>(stringi)</span>
<span id="cb219-5"><a href="optim-caveat.html#cb219-5"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb219-6"><a href="optim-caveat.html#cb219-6"></a>  <span class="kw">tagList</span>(</span>
<span id="cb219-7"><a href="optim-caveat.html#cb219-7"></a>    <span class="kw">textInput</span>(<span class="st">&quot;txt&quot;</span>, <span class="st">&quot;txt&quot;</span>), </span>
<span id="cb219-8"><a href="optim-caveat.html#cb219-8"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;tolower&quot;</span>, <span class="st">&quot;casse&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)), </span>
<span id="cb219-9"><a href="optim-caveat.html#cb219-9"></a>    <span class="kw">checkboxInput</span>(<span class="st">&quot;rev&quot;</span>, <span class="st">&quot;reverse&quot;</span>)</span>
<span id="cb219-10"><a href="optim-caveat.html#cb219-10"></a>  )</span>
<span id="cb219-11"><a href="optim-caveat.html#cb219-11"></a>}</span>
<span id="cb219-12"><a href="optim-caveat.html#cb219-12"></a></span>
<span id="cb219-13"><a href="optim-caveat.html#cb219-13"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session){</span>
<span id="cb219-14"><a href="optim-caveat.html#cb219-14"></a>  r &lt;-<span class="st"> </span><span class="kw">reactiveValues</span>()</span>
<span id="cb219-15"><a href="optim-caveat.html#cb219-15"></a>  <span class="kw">observe</span>({</span>
<span id="cb219-16"><a href="optim-caveat.html#cb219-16"></a>    i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb219-17"><a href="optim-caveat.html#cb219-17"></a>    <span class="kw">cat_rule</span>(<span class="kw">as.character</span>(i))</span>
<span id="cb219-18"><a href="optim-caveat.html#cb219-18"></a>    <span class="cf">if</span> (input<span class="op">$</span>rev) {</span>
<span id="cb219-19"><a href="optim-caveat.html#cb219-19"></a>      r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">stri_reverse</span>(input<span class="op">$</span>txt) </span>
<span id="cb219-20"><a href="optim-caveat.html#cb219-20"></a>    } <span class="cf">else</span> {</span>
<span id="cb219-21"><a href="optim-caveat.html#cb219-21"></a>      r<span class="op">$</span>x &lt;-<span class="st"> </span>input<span class="op">$</span>txt</span>
<span id="cb219-22"><a href="optim-caveat.html#cb219-22"></a>    }</span>
<span id="cb219-23"><a href="optim-caveat.html#cb219-23"></a>    <span class="cf">if</span> (input<span class="op">$</span>tolower <span class="op">==</span><span class="st"> &quot;lower&quot;</span>){</span>
<span id="cb219-24"><a href="optim-caveat.html#cb219-24"></a>      r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">tolower</span>(r<span class="op">$</span>x)</span>
<span id="cb219-25"><a href="optim-caveat.html#cb219-25"></a>    } <span class="cf">else</span> {</span>
<span id="cb219-26"><a href="optim-caveat.html#cb219-26"></a>      r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">toupper</span>(r<span class="op">$</span>x)</span>
<span id="cb219-27"><a href="optim-caveat.html#cb219-27"></a>    }</span>
<span id="cb219-28"><a href="optim-caveat.html#cb219-28"></a>  })</span>
<span id="cb219-29"><a href="optim-caveat.html#cb219-29"></a>}</span>
<span id="cb219-30"><a href="optim-caveat.html#cb219-30"></a></span>
<span id="cb219-31"><a href="optim-caveat.html#cb219-31"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>Ok, now can you tell how many potential invalidation points we have got here?
Three: whenever <code>input$txt</code>, <code>input$rev</code> or <code>input$tolower</code> change.
Of course, three is not that much, but you get the idea.</p>
<p>Let’s pause a minute and think about why we use <code>observe()</code> here.
To update the values inside <code>r$x</code>, yes.
But do we need to use <code>observe()</code> for, say, updating <code>r$x</code> under dozens of conditions, each time the user types a letter?
Possibly not.</p>
<p>We generally want our observer to update its content under a small, controlled number of inputs, i.e. with a controlled number of invalidation points.
And, what we often forget is that users do not type/select correctly on the first try.
No, they usually try and miss, restart, change things, amplifying the reactivity “over-happening”.</p>
<p>Moreover, long <code>observe()</code> statements are hard to debug, and they make collaboration harder when the trigger to the observe logic can potentially lives anywhere between line one and line 257 of your <code>observe()</code>. That’s why (well, in 99% of cases), it is safer to go with <code>observeEvent</code>, as it allows to see at a glance what are the condition under which the content is invalidated and re-evaluated.
Then, if a reactive context is invalidated, <strong>you know why</strong>.
For example, here is where the reactive invalidation can happen</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="optim-caveat.html#cb220-1"></a><span class="kw">observe</span>({</span>
<span id="cb220-2"><a href="optim-caveat.html#cb220-2"></a>  i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb220-3"><a href="optim-caveat.html#cb220-3"></a>  <span class="kw">cat_rule</span>(<span class="kw">as.character</span>(i))</span>
<span id="cb220-4"><a href="optim-caveat.html#cb220-4"></a><span class="op">*</span><span class="st">  </span><span class="cf">if</span> (input<span class="op">$</span>rev) {</span>
<span id="cb220-5"><a href="optim-caveat.html#cb220-5"></a><span class="op">*</span><span class="st">    </span>r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">stri_reverse</span>(input<span class="op">$</span>txt) </span>
<span id="cb220-6"><a href="optim-caveat.html#cb220-6"></a>  } <span class="cf">else</span> {</span>
<span id="cb220-7"><a href="optim-caveat.html#cb220-7"></a><span class="op">*</span><span class="st">    </span>r<span class="op">$</span>x &lt;-<span class="st"> </span>input<span class="op">$</span>txt</span>
<span id="cb220-8"><a href="optim-caveat.html#cb220-8"></a>  }</span>
<span id="cb220-9"><a href="optim-caveat.html#cb220-9"></a><span class="op">*</span><span class="st">  </span><span class="cf">if</span> (input<span class="op">$</span>tolower <span class="op">==</span><span class="st"> &quot;lower&quot;</span>){</span>
<span id="cb220-10"><a href="optim-caveat.html#cb220-10"></a>    r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">tolower</span>(r<span class="op">$</span>x)</span>
<span id="cb220-11"><a href="optim-caveat.html#cb220-11"></a>  } <span class="cf">else</span> {</span>
<span id="cb220-12"><a href="optim-caveat.html#cb220-12"></a>    r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">toupper</span>(r<span class="op">$</span>x)</span>
<span id="cb220-13"><a href="optim-caveat.html#cb220-13"></a>  }</span>
<span id="cb220-14"><a href="optim-caveat.html#cb220-14"></a>})</span></code></pre></div>
<p>Whereas in this code, it is easier to identify where the invalidation can happen:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="optim-caveat.html#cb221-1"></a><span class="kw">observeEvent</span>(</span>
<span id="cb221-2"><a href="optim-caveat.html#cb221-2"></a>  <span class="kw">c</span>(</span>
<span id="cb221-3"><a href="optim-caveat.html#cb221-3"></a><span class="op">*</span><span class="st">  </span>input<span class="op">$</span>rev, </span>
<span id="cb221-4"><a href="optim-caveat.html#cb221-4"></a><span class="op">*</span><span class="st">  </span>input<span class="op">$</span>txt</span>
<span id="cb221-5"><a href="optim-caveat.html#cb221-5"></a>  )</span>
<span id="cb221-6"><a href="optim-caveat.html#cb221-6"></a>  ,{</span>
<span id="cb221-7"><a href="optim-caveat.html#cb221-7"></a>  i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb221-8"><a href="optim-caveat.html#cb221-8"></a>  <span class="kw">cat_rule</span>(<span class="kw">as.character</span>(i))</span>
<span id="cb221-9"><a href="optim-caveat.html#cb221-9"></a>  <span class="cf">if</span> (input<span class="op">$</span>rev) {</span>
<span id="cb221-10"><a href="optim-caveat.html#cb221-10"></a>    r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">stri_reverse</span>(input<span class="op">$</span>txt) </span>
<span id="cb221-11"><a href="optim-caveat.html#cb221-11"></a>  } <span class="cf">else</span> {</span>
<span id="cb221-12"><a href="optim-caveat.html#cb221-12"></a>    r<span class="op">$</span>x &lt;-<span class="st"> </span>input<span class="op">$</span>txt</span>
<span id="cb221-13"><a href="optim-caveat.html#cb221-13"></a>  }</span>
<span id="cb221-14"><a href="optim-caveat.html#cb221-14"></a>  <span class="cf">if</span> (input<span class="op">$</span>tolower <span class="op">==</span><span class="st"> &quot;lower&quot;</span>){</span>
<span id="cb221-15"><a href="optim-caveat.html#cb221-15"></a>    r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">tolower</span>(r<span class="op">$</span>x)</span>
<span id="cb221-16"><a href="optim-caveat.html#cb221-16"></a>  } <span class="cf">else</span> {</span>
<span id="cb221-17"><a href="optim-caveat.html#cb221-17"></a>    r<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">toupper</span>(r<span class="op">$</span>x)</span>
<span id="cb221-18"><a href="optim-caveat.html#cb221-18"></a>  }</span>
<span id="cb221-19"><a href="optim-caveat.html#cb221-19"></a>})</span></code></pre></div>
</div>
<div id="building-triggers-and-watchers" class="section level3">
<h3><span class="header-section-number">16.1.3</span> Building triggers and watchers</h3>
<p>To prevent this, one way to go is to create “flags” objects, which can be thought of as internal buttons to control what you want to invalidate: you create the button, set some places where you want these buttons to invalidate the context, and finally press these</p>
<p>These objects are launched with an <code>init</code> function, then these flags are triggered with <code>trigger()</code>, and wherever we want these flags to invalidate a reactive context, we <code>watch()</code> these flags.</p>
<p>The idea here is to get a full control over the reactive flow: we only invalidate contexts when we want, making the general flow of the app more predictable.
These flags are available using the <code>{gargoyle}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-gargoyle"><strong>???</strong></span>)</span> package, that can be installed from GitHub with:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="optim-caveat.html#cb222-1"></a>remotes<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;ColinFay/gargoyle&quot;</span>)</span></code></pre></div>
<ul>
<li><p><code>gargoyle::init("this")</code> initiate a <code>"this"</code> flag: most of the time you will be generating them at the <code>app_server()</code> level</p></li>
<li><p><code>gargoyle::watch("this")</code> sets the flag inside a reactive context, so that it will be invalidated every time you <code>trigger("this")</code> this flag.</p></li>
<li><p><code>gargoyle::trigger("this")</code> triggers the flags</p></li>
</ul>
<p>And, bonus, as these functions use the <code>session</code> object, they are available across all modules.
That also means that you can easily trigger an event inside a module from another one.</p>
<p>This pattern is for example implemented into <code>{hexmake}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-hexmake"><strong>???</strong></span>)</span> (though not with <code>{gargoyle}</code>), where the rendering of the image on the right is fully controlled by the <a href="https://github.com/ColinFay/hexmake/blob/master/R/mod_right.R#L40"><code>"render"</code> flag</a>.
The idea here is to allow a complete control over when the image is recomputed: only when <code>trigger("render")</code> is called does the app regenerate the image, helping us lower the reactivity of the application.
That might seems like a lot of extra work, but that is definitely worth considering on the long run, as it will help optimizing the rendering (fewer computation) and lowering the number of errors that can result from too much reactivity inside an application.</p>
</div>
<div id="using-r6-as-a-data-storage" class="section level3">
<h3><span class="header-section-number">16.1.4</span> Using R6 as a data storage</h3>
<p>One pattern we have also been playing with is storing the app business logic inside one or more R6 objects.
Why would we want to do that?</p>
<div id="sharing-data-accross-module" class="section level4">
<h4><span class="header-section-number">16.1.4.1</span> Sharing data accross module</h4>
<p>Sharing an R6 object makes it simpler to create data that are shared across modules, but without the complexity generated by reactive objects, and the instability of using global variables.</p>
<p>So basically, the idea is to hold the whole logic of your data reading / cleaning / processing / outputting inside an R6 class.
An object of this class is then initiated at the top level of your application, and you can pass this object to the sub-modules.
Of course, this makes even more sense if you are combining it with the trigger/watch pattern from before!</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="optim-caveat.html#cb223-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb223-2"><a href="optim-caveat.html#cb223-2"></a>nameui &lt;-<span class="st"> </span><span class="cf">function</span>(id){</span>
<span id="cb223-3"><a href="optim-caveat.html#cb223-3"></a>  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)</span>
<span id="cb223-4"><a href="optim-caveat.html#cb223-4"></a>  <span class="kw">tagList</span>(</span>
<span id="cb223-5"><a href="optim-caveat.html#cb223-5"></a>    <span class="co"># [...]</span></span>
<span id="cb223-6"><a href="optim-caveat.html#cb223-6"></a>  )</span>
<span id="cb223-7"><a href="optim-caveat.html#cb223-7"></a>}</span>
<span id="cb223-8"><a href="optim-caveat.html#cb223-8"></a></span>
<span id="cb223-9"><a href="optim-caveat.html#cb223-9"></a>name &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, obj){</span>
<span id="cb223-10"><a href="optim-caveat.html#cb223-10"></a>  ns &lt;-<span class="st"> </span>session<span class="op">$</span>ns</span>
<span id="cb223-11"><a href="optim-caveat.html#cb223-11"></a>  output<span class="op">$</span>that &lt;-<span class="st"> </span><span class="kw">renderThis</span>({</span>
<span id="cb223-12"><a href="optim-caveat.html#cb223-12"></a>    obj<span class="op">$</span><span class="kw">compute</span>()</span>
<span id="cb223-13"><a href="optim-caveat.html#cb223-13"></a>    <span class="kw">trigger</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb223-14"><a href="optim-caveat.html#cb223-14"></a>  })</span>
<span id="cb223-15"><a href="optim-caveat.html#cb223-15"></a>}</span>
<span id="cb223-16"><a href="optim-caveat.html#cb223-16"></a></span>
<span id="cb223-17"><a href="optim-caveat.html#cb223-17"></a>name2ui &lt;-<span class="st"> </span><span class="cf">function</span>(id){</span>
<span id="cb223-18"><a href="optim-caveat.html#cb223-18"></a>  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)</span>
<span id="cb223-19"><a href="optim-caveat.html#cb223-19"></a>  <span class="kw">tagList</span>(</span>
<span id="cb223-20"><a href="optim-caveat.html#cb223-20"></a>    <span class="co"># [...]</span></span>
<span id="cb223-21"><a href="optim-caveat.html#cb223-21"></a>  )</span>
<span id="cb223-22"><a href="optim-caveat.html#cb223-22"></a>}</span>
<span id="cb223-23"><a href="optim-caveat.html#cb223-23"></a></span>
<span id="cb223-24"><a href="optim-caveat.html#cb223-24"></a>name2 &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session){</span>
<span id="cb223-25"><a href="optim-caveat.html#cb223-25"></a>  ns &lt;-<span class="st"> </span>session<span class="op">$</span>ns</span>
<span id="cb223-26"><a href="optim-caveat.html#cb223-26"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderThis</span>({</span>
<span id="cb223-27"><a href="optim-caveat.html#cb223-27"></a>    <span class="kw">watch</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb223-28"><a href="optim-caveat.html#cb223-28"></a>    obj<span class="op">$</span><span class="kw">plot</span>()</span>
<span id="cb223-29"><a href="optim-caveat.html#cb223-29"></a>  })</span>
<span id="cb223-30"><a href="optim-caveat.html#cb223-30"></a>}</span>
<span id="cb223-31"><a href="optim-caveat.html#cb223-31"></a></span>
<span id="cb223-32"><a href="optim-caveat.html#cb223-32"></a></span>
<span id="cb223-33"><a href="optim-caveat.html#cb223-33"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(request){</span>
<span id="cb223-34"><a href="optim-caveat.html#cb223-34"></a>  <span class="kw">tagList</span>(</span>
<span id="cb223-35"><a href="optim-caveat.html#cb223-35"></a>    <span class="kw">nameui</span>(<span class="st">&quot;nameui&quot;</span>),</span>
<span id="cb223-36"><a href="optim-caveat.html#cb223-36"></a>    <span class="kw">name2ui</span>(<span class="st">&quot;name2ui&quot;</span>)</span>
<span id="cb223-37"><a href="optim-caveat.html#cb223-37"></a>  )</span>
<span id="cb223-38"><a href="optim-caveat.html#cb223-38"></a>}</span>
<span id="cb223-39"><a href="optim-caveat.html#cb223-39"></a></span>
<span id="cb223-40"><a href="optim-caveat.html#cb223-40"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb223-41"><a href="optim-caveat.html#cb223-41"></a>  input, </span>
<span id="cb223-42"><a href="optim-caveat.html#cb223-42"></a>  output, </span>
<span id="cb223-43"><a href="optim-caveat.html#cb223-43"></a>  session</span>
<span id="cb223-44"><a href="optim-caveat.html#cb223-44"></a>){</span>
<span id="cb223-45"><a href="optim-caveat.html#cb223-45"></a>  obj &lt;-<span class="st"> </span>MyDataProcess<span class="op">$</span><span class="kw">new</span>()</span>
<span id="cb223-46"><a href="optim-caveat.html#cb223-46"></a>  <span class="kw">callModule</span>(name, <span class="st">&quot;nameui&quot;</span>, obj)</span>
<span id="cb223-47"><a href="optim-caveat.html#cb223-47"></a>  <span class="kw">callModule</span>(name2, <span class="st">&quot;name2ui&quot;</span>, obj)</span>
<span id="cb223-48"><a href="optim-caveat.html#cb223-48"></a>}</span>
<span id="cb223-49"><a href="optim-caveat.html#cb223-49"></a></span>
<span id="cb223-50"><a href="optim-caveat.html#cb223-50"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
</div>
<div id="get-sure-it-is-tested" class="section level4">
<h4><span class="header-section-number">16.1.4.2</span> Get sure it is tested</h4>
<p>During the process of building a robust Shiny app, we strongly suggest that you test as many things as you can.
This is where using an R6 for your business logic of your app makes sense: this allows you to build the whole testing of your application data logic outside of any reactive context: you simply build unit tests just as any other function.</p>
</div>
</div>
</div>
<div id="r-does-too-much" class="section level2">
<h2><span class="header-section-number">16.2</span> R does too much</h2>
<div id="rendering-ui-from-server-side" class="section level3">
<h3><span class="header-section-number">16.2.1</span> Rendering UI from server side</h3>
<p>There are many reasons we would want to change things on the UI based on what happens in the server: changing the choices of a <code>selectInput()</code> based on the columns of a table which is uploaded by the user, showing and hiding pieces of the app according to an environment variable, allow the user to create an indeterminate amount of inputs, etc.</p>
<p>Chances are that to do that, you have been using the <code>uiOutput()</code> &amp; <code>renderUI()</code> functions from <code>{shiny}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-shiny"><strong>???</strong></span>)</span>.
Even if convenient, and the functions of choice in some specific context, this couple makes R do a little bit too much: you are making R regenerate the whole UI component instead of changing only what you need.
Plus, you will create a code that is harder to reason about, as we are used to have the UI parts in the UI functions (but that is not related to performance).</p>
<p>Here are three strategies to code without <code>uiOutput()</code> &amp; <code>renderUI()</code>.</p>
<div id="implement-ui-events-in-javascript" class="section level4">
<h4><span class="header-section-number">16.2.1.1</span> Implement UI events in JavaScript</h4>
<blockquote>
<p>Mixing languages is better than writing everything in one, if and only if using only that one is likely to overcomplicate the program.</p>
</blockquote>
<!--SHINY.SINGLETON[1efbbb1390b1f2da3adcc5776ac72d01ac3af14a]-->
<style>.right{ text-align: right;}</style>
<!--/SHINY.SINGLETON[1efbbb1390b1f2da3adcc5776ac72d01ac3af14a]-->
<div class="right">
<a href="http://www.catb.org/~esr/writings/taoup/html/ch01s08.html">Applying the Unix Philosophy - The Art of Unix Programming</a>
</div>
<p>We will see in the last chapter of this book how you can integrate JS inside your Shiny app, and how even basic functions can be useful for making your app server lighter.
For example, compare:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="optim-caveat.html#cb224-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb224-2"><a href="optim-caveat.html#cb224-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb224-3"><a href="optim-caveat.html#cb224-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb224-4"><a href="optim-caveat.html#cb224-4"></a>    <span class="kw">actionButton</span>(</span>
<span id="cb224-5"><a href="optim-caveat.html#cb224-5"></a>      <span class="st">&quot;change&quot;</span>, </span>
<span id="cb224-6"><a href="optim-caveat.html#cb224-6"></a>      <span class="st">&quot;show/hide graph&quot;</span>, </span>
<span id="cb224-7"><a href="optim-caveat.html#cb224-7"></a>      <span class="dt">onclick =</span> <span class="st">&quot;$(&#39;#plot&#39;).toggle()&quot;</span></span>
<span id="cb224-8"><a href="optim-caveat.html#cb224-8"></a>    ), </span>
<span id="cb224-9"><a href="optim-caveat.html#cb224-9"></a>    <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb224-10"><a href="optim-caveat.html#cb224-10"></a>  )</span>
<span id="cb224-11"><a href="optim-caveat.html#cb224-11"></a>}</span>
<span id="cb224-12"><a href="optim-caveat.html#cb224-12"></a></span>
<span id="cb224-13"><a href="optim-caveat.html#cb224-13"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb224-14"><a href="optim-caveat.html#cb224-14"></a>  input, </span>
<span id="cb224-15"><a href="optim-caveat.html#cb224-15"></a>  output, </span>
<span id="cb224-16"><a href="optim-caveat.html#cb224-16"></a>  session</span>
<span id="cb224-17"><a href="optim-caveat.html#cb224-17"></a>){</span>
<span id="cb224-18"><a href="optim-caveat.html#cb224-18"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb224-19"><a href="optim-caveat.html#cb224-19"></a>    cli<span class="op">::</span><span class="kw">cat_rule</span>(<span class="st">&quot;Rendering plot&quot;</span>)</span>
<span id="cb224-20"><a href="optim-caveat.html#cb224-20"></a>    <span class="kw">plot</span>(iris)</span>
<span id="cb224-21"><a href="optim-caveat.html#cb224-21"></a>  })</span>
<span id="cb224-22"><a href="optim-caveat.html#cb224-22"></a>}</span>
<span id="cb224-23"><a href="optim-caveat.html#cb224-23"></a></span>
<span id="cb224-24"><a href="optim-caveat.html#cb224-24"></a><span class="kw">shinyApp</span>(ui, server) </span></code></pre></div>
<div style="width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;" class="muted well">Shiny applications not supported in static R Markdown documents</div>
<p>to</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="optim-caveat.html#cb225-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb225-2"><a href="optim-caveat.html#cb225-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb225-3"><a href="optim-caveat.html#cb225-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb225-4"><a href="optim-caveat.html#cb225-4"></a>    <span class="kw">actionButton</span>(<span class="st">&quot;change&quot;</span>, <span class="st">&quot;show/hide graph&quot;</span>), </span>
<span id="cb225-5"><a href="optim-caveat.html#cb225-5"></a>    <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb225-6"><a href="optim-caveat.html#cb225-6"></a>  )</span>
<span id="cb225-7"><a href="optim-caveat.html#cb225-7"></a>}</span>
<span id="cb225-8"><a href="optim-caveat.html#cb225-8"></a></span>
<span id="cb225-9"><a href="optim-caveat.html#cb225-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb225-10"><a href="optim-caveat.html#cb225-10"></a>  input, </span>
<span id="cb225-11"><a href="optim-caveat.html#cb225-11"></a>  output, </span>
<span id="cb225-12"><a href="optim-caveat.html#cb225-12"></a>  session</span>
<span id="cb225-13"><a href="optim-caveat.html#cb225-13"></a>){</span>
<span id="cb225-14"><a href="optim-caveat.html#cb225-14"></a>  </span>
<span id="cb225-15"><a href="optim-caveat.html#cb225-15"></a>  r &lt;-<span class="st"> </span><span class="kw">reactiveValues</span>(<span class="dt">plot =</span> iris)</span>
<span id="cb225-16"><a href="optim-caveat.html#cb225-16"></a>  </span>
<span id="cb225-17"><a href="optim-caveat.html#cb225-17"></a>  <span class="kw">observeEvent</span>( input<span class="op">$</span>change , {</span>
<span id="cb225-18"><a href="optim-caveat.html#cb225-18"></a>    <span class="cf">if</span> (input<span class="op">$</span>change <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb225-19"><a href="optim-caveat.html#cb225-19"></a>      r<span class="op">$</span>plot &lt;-<span class="st"> </span>iris</span>
<span id="cb225-20"><a href="optim-caveat.html#cb225-20"></a>    } <span class="cf">else</span> {</span>
<span id="cb225-21"><a href="optim-caveat.html#cb225-21"></a>      r<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb225-22"><a href="optim-caveat.html#cb225-22"></a>    }</span>
<span id="cb225-23"><a href="optim-caveat.html#cb225-23"></a>  })</span>
<span id="cb225-24"><a href="optim-caveat.html#cb225-24"></a>  </span>
<span id="cb225-25"><a href="optim-caveat.html#cb225-25"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb225-26"><a href="optim-caveat.html#cb225-26"></a>    cli<span class="op">::</span><span class="kw">cat_rule</span>(<span class="st">&quot;Rendering plot&quot;</span>)</span>
<span id="cb225-27"><a href="optim-caveat.html#cb225-27"></a>    <span class="kw">req</span>(r<span class="op">$</span>plot)</span>
<span id="cb225-28"><a href="optim-caveat.html#cb225-28"></a>    <span class="kw">plot</span>(r<span class="op">$</span>plot)</span>
<span id="cb225-29"><a href="optim-caveat.html#cb225-29"></a>  })</span>
<span id="cb225-30"><a href="optim-caveat.html#cb225-30"></a>  </span>
<span id="cb225-31"><a href="optim-caveat.html#cb225-31"></a>}</span>
<span id="cb225-32"><a href="optim-caveat.html#cb225-32"></a></span>
<span id="cb225-33"><a href="optim-caveat.html#cb225-33"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<div style="width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;" class="muted well">Shiny applications not supported in static R Markdown documents</div>
<p>The result is the same, but the first version is shorter and easier to reason about: we have one button, and the behavior of the button is contained into itself.
And, on top of being harder to maintain, the second solution redraws the plot every time the <code>reactiveValues</code> is updated, making R compute way more than it should, whereas with the JavaScript only solution, the plot is not recomputed every time you need to show it.</p>
<p>At a local level, the improvements described in this section will not make your application way faster: for example, rendering UI elements (let’s says rendering a simple title) will not be computationally heavy.
But at a global level, lighter UI computation from the server side helps the general rendering of the app: let’s say you have an output that takes 3 seconds to run, then if the whole UI + output is to be rendered on the server side, the whole UI stays blank.</p>
<p>Compare:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="optim-caveat.html#cb226-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb226-2"><a href="optim-caveat.html#cb226-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb226-3"><a href="optim-caveat.html#cb226-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb226-4"><a href="optim-caveat.html#cb226-4"></a>    <span class="kw">uiOutput</span>(<span class="st">&quot;caption&quot;</span>)</span>
<span id="cb226-5"><a href="optim-caveat.html#cb226-5"></a>  )</span>
<span id="cb226-6"><a href="optim-caveat.html#cb226-6"></a>}</span>
<span id="cb226-7"><a href="optim-caveat.html#cb226-7"></a></span>
<span id="cb226-8"><a href="optim-caveat.html#cb226-8"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb226-9"><a href="optim-caveat.html#cb226-9"></a>  input, </span>
<span id="cb226-10"><a href="optim-caveat.html#cb226-10"></a>  output, </span>
<span id="cb226-11"><a href="optim-caveat.html#cb226-11"></a>  session</span>
<span id="cb226-12"><a href="optim-caveat.html#cb226-12"></a>){</span>
<span id="cb226-13"><a href="optim-caveat.html#cb226-13"></a>  output<span class="op">$</span>caption &lt;-<span class="st"> </span><span class="kw">renderUI</span>({</span>
<span id="cb226-14"><a href="optim-caveat.html#cb226-14"></a>    <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb226-15"><a href="optim-caveat.html#cb226-15"></a>    <span class="kw">tagList</span>(</span>
<span id="cb226-16"><a href="optim-caveat.html#cb226-16"></a>      <span class="kw">h3</span>(<span class="st">&quot;test&quot;</span>), </span>
<span id="cb226-17"><a href="optim-caveat.html#cb226-17"></a>      <span class="kw">p</span>(<span class="st">&quot;caption&quot;</span>)</span>
<span id="cb226-18"><a href="optim-caveat.html#cb226-18"></a>    )</span>
<span id="cb226-19"><a href="optim-caveat.html#cb226-19"></a>    </span>
<span id="cb226-20"><a href="optim-caveat.html#cb226-20"></a>  })</span>
<span id="cb226-21"><a href="optim-caveat.html#cb226-21"></a>}</span>
<span id="cb226-22"><a href="optim-caveat.html#cb226-22"></a></span>
<span id="cb226-23"><a href="optim-caveat.html#cb226-23"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<div style="width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;" class="muted well">Shiny applications not supported in static R Markdown documents</div>
<p>to</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="optim-caveat.html#cb227-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb227-2"><a href="optim-caveat.html#cb227-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb227-3"><a href="optim-caveat.html#cb227-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb227-4"><a href="optim-caveat.html#cb227-4"></a>    <span class="kw">h3</span>(<span class="st">&quot;test&quot;</span>), </span>
<span id="cb227-5"><a href="optim-caveat.html#cb227-5"></a>    <span class="kw">textOutput</span>(<span class="st">&quot;caption&quot;</span>)</span>
<span id="cb227-6"><a href="optim-caveat.html#cb227-6"></a>  )</span>
<span id="cb227-7"><a href="optim-caveat.html#cb227-7"></a>}</span>
<span id="cb227-8"><a href="optim-caveat.html#cb227-8"></a></span>
<span id="cb227-9"><a href="optim-caveat.html#cb227-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb227-10"><a href="optim-caveat.html#cb227-10"></a>  input, </span>
<span id="cb227-11"><a href="optim-caveat.html#cb227-11"></a>  output, </span>
<span id="cb227-12"><a href="optim-caveat.html#cb227-12"></a>  session</span>
<span id="cb227-13"><a href="optim-caveat.html#cb227-13"></a>){</span>
<span id="cb227-14"><a href="optim-caveat.html#cb227-14"></a>  output<span class="op">$</span>caption &lt;-<span class="st"> </span><span class="kw">renderText</span>({</span>
<span id="cb227-15"><a href="optim-caveat.html#cb227-15"></a>    <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb227-16"><a href="optim-caveat.html#cb227-16"></a>    <span class="st">&quot;Lorem ipsum dolor&quot;</span></span>
<span id="cb227-17"><a href="optim-caveat.html#cb227-17"></a>  })</span>
<span id="cb227-18"><a href="optim-caveat.html#cb227-18"></a>}</span>
<span id="cb227-19"><a href="optim-caveat.html#cb227-19"></a></span>
<span id="cb227-20"><a href="optim-caveat.html#cb227-20"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<div style="width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;" class="muted well">Shiny applications not supported in static R Markdown documents</div>
<p>In the first example, the UI will wait for the server to have rendered, while in the second we will first see the title, then the rendered text after a few seconds.
That approach makes the user experience better: they know that something is happening, while completely blank page is confusing.</p>
<p>Also, R being single threaded, manipulating DOM elements from the server side make R busy doing these DOM manipulation while it could be computing something else.
And let’s imagine it takes a quarter of a second to render the DOM element, that is a full second for rendering four of them, while R should be busy doing something else!</p>
</div>
<div id="update-inputs" class="section level4">
<h4><span class="header-section-number">16.2.1.2</span> <code>update*</code> inputs</h4>
<p>Almost every Shiny inputs, even the custom ones from packages, come with an <code>update_</code> function that allows to change the input values from the server side, instead of recreating the UI entirely.
For example, here is a way to update the content of a <code>selectInput</code> from the server side:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="optim-caveat.html#cb228-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb228-2"><a href="optim-caveat.html#cb228-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb228-3"><a href="optim-caveat.html#cb228-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb228-4"><a href="optim-caveat.html#cb228-4"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;species&quot;</span>, <span class="st">&quot;Species&quot;</span>, <span class="dt">choices =</span> <span class="ot">NULL</span>), </span>
<span id="cb228-5"><a href="optim-caveat.html#cb228-5"></a>    <span class="kw">actionButton</span>(<span class="st">&quot;update&quot;</span>, <span class="st">&quot;Update&quot;</span>)</span>
<span id="cb228-6"><a href="optim-caveat.html#cb228-6"></a>  )</span>
<span id="cb228-7"><a href="optim-caveat.html#cb228-7"></a>}</span>
<span id="cb228-8"><a href="optim-caveat.html#cb228-8"></a></span>
<span id="cb228-9"><a href="optim-caveat.html#cb228-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb228-10"><a href="optim-caveat.html#cb228-10"></a>  input, </span>
<span id="cb228-11"><a href="optim-caveat.html#cb228-11"></a>  output, </span>
<span id="cb228-12"><a href="optim-caveat.html#cb228-12"></a>  session</span>
<span id="cb228-13"><a href="optim-caveat.html#cb228-13"></a>){</span>
<span id="cb228-14"><a href="optim-caveat.html#cb228-14"></a>  <span class="kw">observeEvent</span>( input<span class="op">$</span>update , {</span>
<span id="cb228-15"><a href="optim-caveat.html#cb228-15"></a>    spc &lt;-<span class="st"> </span><span class="kw">unique</span>(iris<span class="op">$</span>Species)</span>
<span id="cb228-16"><a href="optim-caveat.html#cb228-16"></a>    <span class="kw">updateSelectInput</span>(</span>
<span id="cb228-17"><a href="optim-caveat.html#cb228-17"></a>      session, </span>
<span id="cb228-18"><a href="optim-caveat.html#cb228-18"></a>      <span class="st">&quot;species&quot;</span>, </span>
<span id="cb228-19"><a href="optim-caveat.html#cb228-19"></a>      <span class="dt">choices =</span> spc, </span>
<span id="cb228-20"><a href="optim-caveat.html#cb228-20"></a>      <span class="dt">selected =</span> spc[<span class="dv">1</span>]</span>
<span id="cb228-21"><a href="optim-caveat.html#cb228-21"></a>    )</span>
<span id="cb228-22"><a href="optim-caveat.html#cb228-22"></a>  })</span>
<span id="cb228-23"><a href="optim-caveat.html#cb228-23"></a>  </span>
<span id="cb228-24"><a href="optim-caveat.html#cb228-24"></a>}</span>
<span id="cb228-25"><a href="optim-caveat.html#cb228-25"></a></span>
<span id="cb228-26"><a href="optim-caveat.html#cb228-26"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<div style="width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;" class="muted well">Shiny applications not supported in static R Markdown documents</div>
<p>This switch to <code>updateSelectInput</code> makes the code easier to reason about as the <code>selectInput</code> is where it should be: inside the UI, instead of another pattern where we would use <code>renderUI()</code> and <code>uiOutput()</code>.
Plus, with the <code>update</code> method, we are only changing what is needed, not re-generating the whole input.</p>
</div>
<div id="insertui-and-removeui" class="section level4">
<h4><span class="header-section-number">16.2.1.3</span> <code>insertUI</code> and <code>removeUI</code></h4>
<p>Another way to dynamically change what is in the UI is with <code>insertUI()</code> and <code>removeUI()</code>.
It is more global than the solution we have seen before with setting the <code>reactiveValue</code> to <code>NULL</code> or to a value, as it allows to target a larger UI element: we can insert or remove the whole input, instead of having the DOM element inserted but empty.
This method allows to have a lighter DOM: <code>&lt;div&gt;</code> which are not rendered are not generated empty, they are simply not there.</p>
<p>Two things to note concerning this method, though:</p>
<ul>
<li>Removing an element from the app will not delete the input from the input list.
In other word, if you have <code>selectInput("x", "x")</code>, and that you remove this input using <code>removeUI()</code>, you will still have <code>input$x</code> in the server.</li>
</ul>
<p>For example, in the following example, the <code>input$val</code> value will not be removed once you have called <code>removeUI(selector = "#val")</code>.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="optim-caveat.html#cb229-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb229-2"><a href="optim-caveat.html#cb229-2"></a>ui &lt;-<span class="st"> </span><span class="cf">function</span>(){</span>
<span id="cb229-3"><a href="optim-caveat.html#cb229-3"></a>  <span class="kw">tagList</span>(</span>
<span id="cb229-4"><a href="optim-caveat.html#cb229-4"></a>    <span class="kw">textInput</span>(<span class="st">&quot;val&quot;</span>, <span class="st">&quot;Value&quot;</span>, <span class="st">&quot;place&quot;</span>),</span>
<span id="cb229-5"><a href="optim-caveat.html#cb229-5"></a>    <span class="kw">actionButton</span>(<span class="st">&quot;rm&quot;</span>, <span class="st">&quot;Remove UI&quot;</span>)</span>
<span id="cb229-6"><a href="optim-caveat.html#cb229-6"></a>  )</span>
<span id="cb229-7"><a href="optim-caveat.html#cb229-7"></a>}</span>
<span id="cb229-8"><a href="optim-caveat.html#cb229-8"></a></span>
<span id="cb229-9"><a href="optim-caveat.html#cb229-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb229-10"><a href="optim-caveat.html#cb229-10"></a>  input, </span>
<span id="cb229-11"><a href="optim-caveat.html#cb229-11"></a>  output, </span>
<span id="cb229-12"><a href="optim-caveat.html#cb229-12"></a>  session</span>
<span id="cb229-13"><a href="optim-caveat.html#cb229-13"></a>){</span>
<span id="cb229-14"><a href="optim-caveat.html#cb229-14"></a>  </span>
<span id="cb229-15"><a href="optim-caveat.html#cb229-15"></a>  <span class="kw">observeEvent</span>( input<span class="op">$</span>rm , {</span>
<span id="cb229-16"><a href="optim-caveat.html#cb229-16"></a>    <span class="kw">removeUI</span>(<span class="dt">selector =</span> <span class="st">&quot;#val&quot;</span>)</span>
<span id="cb229-17"><a href="optim-caveat.html#cb229-17"></a>  })</span>
<span id="cb229-18"><a href="optim-caveat.html#cb229-18"></a>  </span>
<span id="cb229-19"><a href="optim-caveat.html#cb229-19"></a>  <span class="kw">observe</span>({</span>
<span id="cb229-20"><a href="optim-caveat.html#cb229-20"></a>    <span class="kw">invalidateLater</span>(<span class="dv">1000</span>)</span>
<span id="cb229-21"><a href="optim-caveat.html#cb229-21"></a>    <span class="kw">print</span>(input<span class="op">$</span>val)</span>
<span id="cb229-22"><a href="optim-caveat.html#cb229-22"></a>  })</span>
<span id="cb229-23"><a href="optim-caveat.html#cb229-23"></a></span>
<span id="cb229-24"><a href="optim-caveat.html#cb229-24"></a>}</span>
<span id="cb229-25"><a href="optim-caveat.html#cb229-25"></a></span>
<span id="cb229-26"><a href="optim-caveat.html#cb229-26"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<div style="width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;" class="muted well">Shiny applications not supported in static R Markdown documents</div>
<ul>
<li>Both these functions take a <code>jQuery</code> selector to select the element in the UI.
We will introduce these selectors in the last chapter of this book.</li>
</ul>
</div>
</div>
<div id="too-much-data-in-memory" class="section level3">
<h3><span class="header-section-number">16.2.2</span> Too Much Data in Memory</h3>
<p>If you are building a Shiny application, there is a great chance you are building it to analyze data.
If you are dealing with large datasets, you should consider deporting the data handling and computation to an external database system: for example to an SQL database.
Why? Because these system has been created to handle and manipulate data on disk: in other words it will allow you to perform operation on your data without having to clutter R memory with large dataset.</p>
<p>For example, if you have a <code>selectInput()</code> that is used to perform a filter on a dataset, you can do that filter straight inside SQL, instead of bringing all the data to R and then do the filter.
That is even more necessary if you are building the app for a large number of users: for example if one Shiny session takes up to 300MB, multiply that by the number of users that will need one session, and you will have a rough estimate of how many RAM you will need.
On the contrary, if you lighten the data manipulation so that it is done by the back-end, you will have, let’s say, one database with 300 mo of data, then the database size will remain (more or less constant), and the only RAM used by Shiny will be the data manipulation, not the data storage.
That’s even more true now that almost any operation you can do today in <code>{dplyr}</code> <span class="citation">(Wickham et al. <a href="#ref-R-dplyr" role="doc-biblioref">2020</a>)</span> would be doable with an SQL backend, and that is the purpose of the <code>{dbplyr}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-dbplyr"><strong>???</strong></span>)</span> package: translate <code>{dplyr}</code> code into SQL.</p>
<p>If using a database as a back-end seems a little bit far-fetched right now, that is how it is done in most programming languages: if you are building a web app with NodeJS or Python for example, and need to interact with data, nothing will be stored in RAM: you will be relying on an external database to store your data.
Then your application will be used to make queries to this database backend.</p>
</div>
</div>
<div id="reading-data" class="section level2">
<h2><span class="header-section-number">16.3</span> Reading data</h2>
<p>Shiny applications are a tool of choice when it comes to analyzing data.
But that also means that these data have to be imported/read at some point in time, and reading data can be time consuming.
How can we optimize that?
In this section, we will have a look at three strategies: including datasets inside your application, using R packages for fast data reading, and when and why you should move to an external database system.</p>
<div id="including-data-in-your-application" class="section level3">
<h3><span class="header-section-number">16.3.1</span> Including Data in your Application</h3>
<p>If you are building your application using the <code>{golem}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-golem"><strong>???</strong></span>)</span> framework, you are building your application as a package.
R packages provide a way to include internal datasets, that can then be used as objects inside your app.
This is the solution you should go for if your data are never to rarely updated: the datasets are created during package development, then included inside the build of your package.
The plus side of this approach is that it makes the data fast to read, as they are serialized as R native objects.</p>
<p>To include data inside your application, you can use the <code>usethis::use_data_raw( name = "my_dataset", open = FALSE )</code> command which is inside the <code>02_dev.R</code> script inside the <code>dev/</code> folder of your source application (if you are building the app with <code>{golem}</code>).
This will create a folder called <code>data-raw</code> at the root of your application folder, with a script to prepare your dataset.
Here, you can read the data, modify it if necessary, and then save it with <code>usethis::use_data(my_dataset)</code>.
Once this is done, you will have access to the <code>my_dataset</code> object inside your application.</p>
<p>This is for example what is done in the <code>{tidytuesday201942}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-tidytuesday201942"><strong>???</strong></span>)</span> application, at <a href="https://github.com/ColinFay/tidytuesday201942/blob/master/data-raw/big_epa_cars.R">data-raw/big_epa_cars.R</a>: the csv is read there, and then used as an internal dataset inside the application.</p>
</div>
<div id="reading-external-datasets" class="section level3">
<h3><span class="header-section-number">16.3.2</span> Reading External Datasets</h3>
<p>Other applications use data that are not available at build time: they are created to analyse data that are uploaded by users, or maybe they are fetch on an external service while using the app (for example by calling an API).
When you are building an application for the “user data” use case, the first thing you will need is to provide users a way to upload their dataset: <code>shiny::fileInput()</code>.</p>
<p>One crucial thing to keep in mind when it comes to using user-uploaded files is that you have to be (very) strict with the way you handle files:</p>
<ul>
<li>Always specify what type of file you want: <code>shiny::fileInput()</code> has an <code>accept</code> parameter that allows you to set one or more <a href="https://en.wikipedia.org/wiki/Media_type">MIME types</a> or extension.
When using this argument (for example with <code>text/csv</code>, <code>.csv</code>, or <code>.xslx</code>), the user will only be able to select a subset of files from their computer: the ones that matches the type.</li>
<li>Always perform checks once the file is uploaded, even more if it is tabular data: column type, naming, empty rows…
The more you check the file for potential errors, the less your application is likely to fail to analyze this uploaded dataset.</li>
<li>If the data reading takes a while, do not forget to add a visual progression cue: be it a <code>shiny::withProgress()</code> or tools from the <a href="https://github.com/JohnCoene/waiter"><code>{waiter}</code></a> package.</li>
</ul>
<p>Why do we do that?
Because whenever you offer a user the possibility to upload anything, you can be sure that at some point, they will upload a file that will make the app crash.
By setting a specific MIME type and by doing a series of check once the file is uploaded, you will make your application more stable.
Finally, having a visual cue that “something is happening” is very important for the user experience, as “something is happening” is better than not knowing what is happening, and it may also prevent the user from clicking again and again on the upload button.</p>
<p>Now we have our <code>fileInput()</code> set, how do we read these data as fast as possible?
There are several options depending on the type of data you are reading.
Here are some packages that can make the file reading faster:</p>
<ul>
<li>For tabular, flat dataset (typically csv, tsv, or text), <code>{vroom}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-vroom"><strong>???</strong></span>)</span> can read data at a 1.40 GB/sec/sec speed.
<code>{data.table}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-data.table"><strong>???</strong></span>)</span>, and its <code>fread()</code> function, is also fast at reading delimited files.</li>
<li>For JSON files, <code>{jsonlite}</code> <span class="citation">(Ooms <a href="#ref-jsonlite2014" role="doc-biblioref">2014</a>)</span></li>
<li>If you need to read Excel files inside your app, <code>{readxl}</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-readxl"><strong>???</strong></span>)</span> offers a binding to the <a href="http://rapidxml.sourceforge.net/"><code>RapidXML</code></a> C++ library, reading Excel files fast.</li>
</ul>
</div>
<div id="using-external-databases" class="section level3">
<h3><span class="header-section-number">16.3.3</span> Using External DataBases</h3>
<p>Another type of data analysed in a shiny application is one contained inside an external database.
Database are wildly used in the data science world, and in the software engineering as a whole.
Being a widely used source of data, databases come with API and drivers that help retrieving and transferring data: be it SQL, NoSQL, or even graph.</p>
<p>Using a database is one of the solution for making your app lighter, and more efficient in the long run, notably if you need to scale your app to thousands of visitors.
Indeed, if you plan on having your app scale to numerous people, that will mean that a lot of R processes will be triggered.
And if your data is contained in your app, this will mean that each R process will take a significant amount of RAM if the dataset is large.
For example, if your dataset alone takes ~300 mb of RAM, that means that if you want to launch the app 10 times, you will need ~3gb of RAM.
On the other hand, if you decide to switch these data to an external database, it will lower the global RAM need: the DB will takes these 300mb of data, and each shiny application will make request to the database.
So, schematically, if the database needs 300mb, and one shiny app 50mb, then 10 app will be 300mb + 50 * 1b mo.
Of course, it is not as simplistic as that, and other things are to be considered: making database requests can be computationally expensive, and might need some network adjustments, but you get the idea.</p>
<p>Covering all the available type of databases and the packages associated with each is a very, very large topic: there are dozens of database systems, and as many (if not more) packages to interact with them.
For a more extensive coverage of using databases in R, please follow these resources:</p>
<ul>
<li><p><a href="https://db.rstudio.com/">Databases using R</a>, the official RStudio documentation around databases and R</p></li>
<li><p><a href="https://colinfay.me/r-db/">colinfay/r-db</a>, a docker image, with an companion guide, that bundles the toolchain for a lot of database systems for R</p></li>
<li><p><a href="https://cran.r-project.org/web/views/Databases.html">CRAN Task View: Databases with R</a>: the official task view from CRAN with a series of packages for database manipulation</p></li>
</ul>
</div>
<div id="reminder" class="section level3">
<h3><span class="header-section-number">16.3.4</span> Reminder</h3>
<p>How to choose between these three methodologies:</p>
<table>
<thead>
<tr class="header">
<th align="left">Choice</th>
<th align="left">Update</th>
<th align="left">Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Package data</td>
<td align="left">Never to very rare</td>
<td align="left">Low to medium</td>
</tr>
<tr class="even">
<td align="left">Reading files</td>
<td align="left">Uploaded by Users</td>
<td align="left">Preferably low</td>
</tr>
<tr class="odd">
<td align="left">External DataBase</td>
<td align="left">Never to Streaming</td>
<td align="left">Low to Big</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-jsonlite2014">
<p>Ooms, Jeroen. 2014. “The Jsonlite Package: A Practical and Consistent Mapping Between Json Data and R Objects.” <em>arXiv:1403.2805 [stat.CO]</em>. <a href="https://arxiv.org/abs/1403.2805">https://arxiv.org/abs/1403.2805</a>.</p>
</div>
<div id="ref-R-dplyr">
<p>Wickham, Hadley, Romain François, Lionel Henry, and Kirill Müller. 2020. <em>Dplyr: A Grammar of Data Manipulation</em>. <a href="https://CRAN.R-project.org/package=dplyr">https://CRAN.R-project.org/package=dplyr</a>.</p>
</div>
</div>
<hr/>
<footer>
<a href="rtask.thinkr.fr"><img src="img/logo400_129.png" alt="ThinkR Website"/></a>
</footer>
            </section>

          </div>
        </div>
      </div>
<a href="when-optimize.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="optimizing-shiny-code.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ThinkR-open/building-shiny-apps-workflow/edit/master/16-common-app-caveats.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
